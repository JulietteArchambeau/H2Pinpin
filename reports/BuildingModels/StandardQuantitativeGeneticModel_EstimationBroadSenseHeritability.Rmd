---
title: "Broad-sense heritability of each trait"
author: "Juliette Archambeau"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    # code_fold: hide
    toc: true
    toc_depth: 4
    toc_float:
       collapsed: false
    number_sections: true
    highlight: textmate
editor_options: 
  chunk_output_type: console
---

<style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;
  white-space: pre;
}
</style>

<style type="text/css">
div.main-container {
  max-width: 2000px;
  margin-left: auto;
  margin-right: auto;
}
</style>


```{css, echo=FALSE}
pre {
  max-height: 300px;
  overflow-y: auto;
}

pre[class] {
  max-height: 600px;
}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 5,fig.height = 4,cache=F)
options(width = 300)
library(knitr)        # CRAN v1.26
library(reshape2)     # CRAN v1.4.4
library(dplyr)        # CRAN v1.0.0
library(tidyverse)    # CRAN v1.3.0
library(kableExtra)   # CRAN v1.1.0
library(rstan)        # CRAN v2.19.2
library(broom)        # CRAN v0.5.2
library(loo)          # CRAN v2.2.0
library(latex2exp)    # CRAN v0.4.0
library(parallel)
library(tidytidbits)  # CRAN v0.2.3
library(tidybayes)    # CRAN v2.0.1
library(bayesplot)    # CRAN v1.7.1
library(cowplot)      # CRAN v1.0.0
library(xtable)
theme_set(theme_bw(base_size = 20))
color_scheme_set("green")
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```



# Model equation and code

In this document, we estimate the broad-sense heritability of each trait $y_{bpcr}$ based on the following quantitative genetic model:

\begin{equation}
\begin{aligned}
y_{bpcr} & \sim  \mathcal{N}(\mu_{bpc},\sigma^{2}_{r})\\[3pt]
\mu_{bpc} & =  \beta_{0} +  B_{b} + P_{p} + C_{c(p)}\\[3pt]
\end{aligned}
\end{equation}

where $\beta_{0}$ is the global intercept, $B_{b}$ the block intercepts, $P_{p}$ the population intercepts, $C_{c(p)}$ the clone intercepts and $\sigma^{2}_{r}$ the residual variance.

The prior of $\beta_{0}$ was weakly informative and centered around the mean of the observed values for the trait under considered, as follows:

$$\beta_{0} \sim \mathcal{N}(\mu_{y},2)$$

The population, clone and block intercepts, $P_{p}$, $C_{c(p)}$ and $B_{b}$ were considered normally-distributed with variances $\sigma^{2}_{P}$, $\sigma^{2}_{C}$ and $\sigma^{2}_{B}$, such as:

$$\begin{bmatrix} B_{b} \\ P_{p}\\ C_{c(p)} \end{bmatrix} 
    \sim \mathcal{N}\left(0,
\begin{bmatrix}\sigma^{2}_{B}\\[3pt]
\sigma^{2}_{P}\\
\sigma^{2}_{C}\\
\end{bmatrix}
\right)\\[3pt]$$


To partition the total variance, we parameterize our model so that only the total variance, $\sigma_{tot}^{2}$ has a prior, such that:

\begin{equation}
\begin{aligned}
\sigma_{tot}^{2} & = \sigma_{r}^{2} + \sigma_{B}^{2} + \sigma_{C}^{2} + \sigma_{P}^{2}\\[3pt]
\sigma_{r} & = \sigma_{tot} \times \sqrt(\pi_{r})\\[3pt]
\sigma_{B} & = \sigma_{tot} \times \sqrt(\pi_{B})\\[3pt]
\sigma_{P} & = \sigma_{tot} \times \sqrt(\pi_{P})\\[3pt]
\sigma_{C} & = \sigma_{tot} \times \sqrt(\pi_{C})\\[3pt]
\sigma_{tot} & \sim \mathcal{S}^{*}(0,1,3)
\end{aligned}
\end{equation}

where $\sum_{l}^{4}\pi_{l}=1$ (using the `simplex` function in `Stan`).

Here is the stan model code:

```{r ModelCompilation}
model = stan_model("scripts/StanModels/HierarchicalModel_StandardQuantitativeGeneticModel.stan")
model
```

# Options and parameters

```{r OptionDocs}
# Options for sampling
n_chains <- 4
n_iter <- 2500
n_warm <- 1250
n_thin <- 1
save_warmup = FALSE 

theme_set(theme_bw(base_size = 20))

# option for the MCMC intervals
point.est="median"

conf.level <- 0.95
```

```{r Parameters}
traits <- c("POR_htoct12","AST_htnov12","BDX_htnov13","BDX_htnov18","MeanBB","MeanDBB","POR_SLA","d13C")
d13c <- parse(text = TeX("$\\delta^{13}C$ (Fundão)"))
trait.labels <- c("Height (Fundão, 20 months)",
                    "Height (Asturias, 21 months)",
                    "Height (Bordeaux, 25 months)",
                    "Height (Bordeaux, 85 months)",
                    "Mean bud burst date (Bordeaux)",
                    "Mean duration of bud burst (Bordeaux)",
                    "Specific Leaf Area (Fundão)",
                    d13c)
trait.colors <- c("#B2182B","#D73027","#F46D43", "#FDAE61","#5AAE61","#A6DBA0" ,"#4575B4", "#ABD9E9")
trait.shapes <- c(16,16,16,16, 17,17,15,15)
```

# Running and saving the models

> Function to download and format the data

```{r FunctionDownloadFormatData,eval=F}
DownloadData <- function(trait){

#### Trait transformations
    # Phenology-realted traits and delta13C are centered to help convergence
if(trait=="MeanBB"|trait=="MeanDBB"|trait=="d13C"){
    CenterResponseVariable <- TRUE
    LogResponseVariable <- FALSE
    
    # SLA is not centered and we used its logarithm as response variable
  }  else if(trait=="POR_SLA"){ 
    CenterResponseVariable <- FALSE
    LogResponseVariable <- TRUE
    
    # Height is not transformed
  } else { 
    CenterResponseVariable <- FALSE
    LogResponseVariable <- FALSE
  }


#### Merging with the phenotypic data
  if(trait=="MeanBB"|trait=="MeanDBB"){
      
  df <- readRDS(file="data/ClonapinData/PhenoDataNovember2019_AnnualTraits.rds") %>% 
    dplyr::filter(!(prov=="MAD")) %>% 
    when(trait=="MeanBB" ~ dplyr::select(.,prov,clon,tree,block,BDX_s32013,BDX_s32014,BDX_s32015,BDX_s32017),
         ~ dplyr::select(.,prov,clon,tree,block,BDX_dbb2014,BDX_dbb2015,BDX_dbb2017)) %>% 
    filter(rowSums(is.na(across(where(is.numeric)))) != ncol(.)-4) %>% 
    dplyr::mutate(trait = rowMeans(select(.,contains("BDX")),na.rm=T)) %>%
    execute_if(CenterResponseVariable, mutate(trait=trait-mean(trait))) %>% 
    execute_if(LogResponseVariable, mutate(trait=log(trait))) %>% 
    arrange(by=tree)
  
  } else {
    
  df <- readRDS(file="data/ClonapinData/PhenoDataNovember2019_AnnualTraits.rds") %>% 
    dplyr::filter(!(prov=="MAD")) %>% 
    dplyr::rename(trait=all_of(trait)) %>% 
    dplyr::select(prov,clon,tree,block,trait) %>% 
    drop_na() %>%  
    execute_if(CenterResponseVariable, mutate(trait=trait-mean(trait))) %>% 
    execute_if(LogResponseVariable, mutate(trait=log(trait))) %>% 
    arrange(by=tree)
  
  }
  
  
# the list for stan:

list.stan <- list(N=length(df$tree),
         y=df$trait,
         nprov = length(unique(df$prov)),
         nclon = length(unique(df$clon)),
         nblock = length(unique(df$block)),
         prov = as.numeric(as.factor(df$prov)),
         clon = as.numeric(as.factor(df$clon)),
         bloc = as.numeric(as.factor(df$block)))
  
}
```

```{r RunModel,eval=F}
list.models <- list()

set.seed(56)

for(trait in traits){
  
stanlist <- DownloadData(trait)


list.models[[trait]] <- sampling(model, 
                               data = stanlist, 
                               pars=c("beta0",
                                      "pi","sigma2_r","sigma2_block","sigma2_prov","sigma2_clon",
                                      "H2",
                                      "sigma_tot","sigma_block","sigma_prov","sigma_clon",
                                      "R_squared"),
                               iter = n_iter, 
                               chains = n_chains, 
                               cores = n_chains,
                               save_warmup = save_warmup,
                               thin=n_thin,
                               control=list(max_treedepth=12))
}


saveRDS(list.models,file=paste0("outputs/models/StandardQuantGenModel.rds"))
```

# Figures

## Broad-sense heritability $H^2$

```{r StandardQuantGenModelH2,fig.height=6,fig.width=8}
post <- readRDS(file=paste0("outputs/models/StandardQuantGenModel.rds"))  %>% 
  mclapply(function(x) broom::tidyMCMC(x,pars=("H2"),
              droppars = NULL, 
              estimate.method = point.est, 
              ess = F, 
              rhat = F, 
              conf.int = T,
              conf.level = conf.level)) %>% 
  bind_rows(.id="Traits")  %>% 
  mutate(Traits=factor(Traits,levels=traits))


# Table for the Supplementary Information:
post %>% 
  dplyr::select(Traits,estimate,conf.low,conf.high) %>% 
  xtable(type = "latex",digits=3) %>% 
  print(file = paste0("tables/HeritabilityEstimates_StandardQuantitativeGeneticModel.tex"), 
      include.rownames=FALSE)


p <- post  %>%   
  ggplot(aes(x=term,y = estimate,ymin = conf.low, ymax = conf.high,colour=Traits,shape=Traits)) +
  geom_pointinterval(position = position_dodge(width = .6),point_size=2.5,size=3,show.legend = c(size = TRUE)) +
  ylab(TeX("$H^{2}$ estimates")) + xlab("") +
  scale_colour_manual(labels = trait.labels,
                     values = trait.colors) +
  scale_shape_manual(labels = trait.labels,
                     values = trait.shapes) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=16),
        axis.title = element_text(size=16),
        legend.title=element_text(size=13), 
        legend.text=element_text(size=10),
        axis.ticks.x = element_blank(),
        strip.text.x = element_blank(),
        panel.grid.minor.x=element_blank(),
        panel.grid.major.x=element_blank()) +
  guides(color=guide_legend(ncol=1,override.aes = list(size=2)))

ggsave(p,file="figs/PosteriorDistributions/StandardQuantGenModel_BroadSenseHeritability.png",height=6,width=8)

# Another possible visualisation:

# p <- post  %>%   
#   ggplot(aes(x=estimate,y = Traits,colour=Traits,shape=Traits)) +
#   geom_point(size=4) + # 
#   geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),height=0.1,size=1,show.legend = c(size = TRUE)) +
#   xlab(TeX("$H^{2}$ estimates")) + ylab("") +
#   scale_y_discrete() +
#   scale_colour_manual(values=trait.colors) +
#   scale_shape_manual(values = trait.shapes) +
#   theme_bw() +
#   theme(axis.text.x = element_text(size=16),
#         axis.text.y = element_text(size=16),
#         axis.title = element_text(size=16),
#       legend.title=element_text(size=13), 
#       legend.text=element_text(size=10),
#       axis.ticks.x = element_blank(),
#       legend.position = "none",
#       strip.text.x = element_blank(),
#       panel.grid.minor.y=element_blank(),
#       panel.grid.major.y=element_blank()) +
#     guides(color=guide_legend(ncol=1,override.aes = list(size=2)))

# ggsave(p,file="figs/PosteriorDistributions/StandardQuantGenModel_BroadSenseHeritability_V2.png",height=8,width=14)

p
```

## Variance partitioning

```{r StandardQuantGenModelPI,fig.height=8,fig.width=12}
post <- readRDS(file=paste0("outputs/models/StandardQuantGenModel.rds"))  %>% 
  mclapply(function(x) broom::tidyMCMC(x,pars=("pi"),
              droppars = NULL, 
              estimate.method = point.est, 
              ess = F, 
              rhat = F, 
              conf.int = T,
              conf.level = conf.level) %>% 
             dplyr::mutate(pi=c("Residuals","Blocks","Populations","Clones"))) %>% 
  bind_rows(.id="Traits") %>% 
  mutate(Traits=factor(Traits,levels=traits)) %>% 
  mutate(pi=factor(pi,levels=c("Blocks","Populations","Clones","Residuals")))
  

p <- post  %>%   ggplot(aes(x = pi, y = estimate,ymin = conf.low, ymax = conf.high,colour=Traits,shape=Traits)) +
  geom_pointinterval(position = position_dodge(width = .6),point_size=2.5,size=3,show.legend = c(size = TRUE)) +
  ylab(TeX("Proportion of variance explained")) + xlab("") +
  scale_colour_manual(labels=trait.labels,
                      values=trait.colors) +
  scale_shape_manual(labels=trait.labels,
                     values = trait.shapes) +
  theme_bw() +
  theme(axis.text.x = element_text(size=13),
        axis.text.y = element_text(size=16),
        axis.title = element_text(size=16),
        legend.title=element_text(size=13), 
        legend.text=element_text(size=10),
        strip.text.x = element_text(size = 14),
        panel.grid.minor.x=element_blank(),
        panel.grid.major.x=element_blank()) +
  guides(color=guide_legend(ncol=1,override.aes = list(size=2)))

ggsave(p,file="figs/PosteriorDistributions/StandardQuantGenModel_VariancePartitioning.png",height=8,width=12)
p
```

