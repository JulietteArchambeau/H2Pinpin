---
title: "Bayesian analysis to associate within-population genetic variation with potential underlying drivers"
subtitle: "Based on real data"
author: "Juliette Archambeau"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    # code_fold: hide
    toc: true
    toc_depth: 4
    toc_float:
       collapsed: false
    number_sections: true
    highlight: textmate
editor_options: 
  chunk_output_type: console
---

<style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;
  white-space: pre;
}
</style>

<style type="text/css">
div.main-container {
  max-width: 2000px;
  margin-left: auto;
  margin-right: auto;
}
</style>


```{css, echo=FALSE}
pre {
  max-height: 300px;
  overflow-y: auto;
}

pre[class] {
  max-height: 600px;
}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 5,fig.height = 4,cache=F)
options(width = 300)
library(knitr)        # CRAN v1.26
library(reshape2)     # CRAN v1.4.4
library(dplyr)        # CRAN v1.0.0
library(tidyverse)    # CRAN v1.3.0
library(kableExtra)   # CRAN v1.1.0
library(rstan)        # CRAN v2.19.2
library(broom)        # CRAN v0.5.2
library(loo)          # CRAN v2.2.0
library(latex2exp)    # CRAN v0.4.0
library(parallel)
library(tidytidbits)  # CRAN v0.2.3
library(tidybayes)    # CRAN v2.0.1
library(bayesplot)    # CRAN v1.7.1
library(cowplot)      # CRAN v1.0.0
theme_set(theme_bw(base_size = 20))
color_scheme_set("green")
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```

`r knitr::opts_chunk$set(eval = F)`

```{r OptionDocs}
# Options for sampling
n_chains <- 4
n_iter <- 2500
n_warm <- 1250
n_thin <- 1
save_warmup = FALSE 

theme_set(theme_bw(base_size = 20))

# option for the MCMC intervals
point.est="median"

conf.level <- 0.95
```

# Mathematical model

In this document, we aim to estimate the relationship between potential drivers (namely, two admixture scores, four indexes of environmental heterogeneity and two indexes of climatic harshness) and the within-population genetic variation. 

For each potential driver $X_{p}$, we model the normally-distributed traits $y_{bpcr}$ with the following statistical model:

\begin{equation}
\begin{aligned}
y_{bpcr} & \sim  \mathcal{N}(\mu_{bpc},\sigma^{2}_{r})\\[3pt]
\mu_{bpc} & =  \beta_{0} +  B_{b} + P_{p} + C_{c(p)}\\[3pt]
\beta_{0} & \sim \mathcal{N}(\mu_{y},2)\\[3pt]
\begin{bmatrix} B_{b} \\ P_{p} \end{bmatrix} 
    &\sim \mathcal{N}\left(0,
\begin{bmatrix}
\sigma^{2}_{B}\\[3pt]
\sigma^{2}_{P}\\
\end{bmatrix}
\right)\\[3pt]
C_{c(p)} & \sim \mathcal{N}(0,\sigma^{2}_{C_{p}})\\[3pt]
\overline{\sigma_{C_{p}}^{2}} & = \frac{\sum_{p=1}^{33} \sigma_{C_{p}}^{2}}{33} \\[3pt]
\sigma_{tot}^{2} & = \sigma_{r}^{2} + \sigma_{B}^{2} + \overline{\sigma_{C_{p}}^{2}} + \sigma_{P}^{2}\\[3pt]
\sigma_{r} & = \sigma_{tot} \times \sqrt(\pi_{r})\\[3pt]
\sigma_{B} & = \sigma_{tot} \times \sqrt(\pi_{B})\\[3pt]
\sigma_{P} & = \sigma_{tot} \times \sqrt(\pi_{P})\\[3pt]
\sigma_{C_{p}} & \sim \mathcal{LN}\left(\ln\left(\sigma_{tot} \times  \sqrt(\pi_{C})\right)-\frac{\sigma^{2}_{K}}{2} + \beta_{x}X_{p},\sigma^{2}_{K}\right)\\[3pt]
\sigma_{K} & \sim \exp(1)\\[3pt]
\sigma_{tot} & \sim \mathcal{S}^{*}(0,1,3)
\end{aligned}
\end{equation}



Here is the stan model code:

```{r ModelCompilation,eval=F}
model = stan_model("scripts/StanModels/HierarchicalModel_VaryingInterClonesSD_OneCovariate.stan")
```


# Functions used

```{r FunctionDownloadFormatData,eval=F}
DownloadData <- function(trait){

#### Trait transformations
    # Phenology-realted traits and delta13C are centered to help convergence
if(trait=="MeanBB"|trait=="MeanDBB"|trait=="d13C"){
    CenterResponseVariable <- TRUE
    LogResponseVariable <- FALSE
    
    # SLA is not centered and we used its logarithm as response variable
  }  else if(trait=="POR_SLA"){ 
    CenterResponseVariable <- FALSE
    LogResponseVariable <- TRUE
    
    # Height is not transformed
  } else { 
    CenterResponseVariable <- FALSE
    LogResponseVariable <- FALSE
  }

  
#### Downloading the potential drivers
  drivers <- readRDS(file="data/DF_Drivers.rds") %>% 
    dplyr::select(prov,A,D,EH.20km.PC1,EH.20km.PC2,EH.1km.PC1,EH.1km.PC2,SHM,invEMT) %>% 
    dplyr::mutate(across(-prov,scale))

  
  
#### Merging with the phenotypic data
  if(trait=="MeanBB"|trait=="MeanDBB"){
      
  df <- readRDS(file="data/ClonapinData/PhenoDataNovember2019_AnnualTraits.rds") %>% 
    dplyr::filter(!(prov=="MAD")) %>% 
    when(trait=="MeanBB" ~ dplyr::select(.,prov,clon,tree,block,BDX_s32013,BDX_s32014,BDX_s32015,BDX_s32017),
         ~ dplyr::select(.,prov,clon,tree,block,BDX_dbb2014,BDX_dbb2015,BDX_dbb2017)) %>% 
    filter(rowSums(is.na(across(where(is.numeric)))) != ncol(.)-4) %>% 
    dplyr::mutate(trait = rowMeans(select(.,contains("BDX")),na.rm=T)) %>%
    execute_if(CenterResponseVariable, mutate(trait=trait-mean(trait))) %>% 
    execute_if(LogResponseVariable, mutate(trait=log(trait))) %>% 
    arrange(by=tree) %>% 
    inner_join(drivers,by="prov") 
  
  } else {
    
  df <- readRDS(file="data/ClonapinData/PhenoDataNovember2019_AnnualTraits.rds") %>% 
    dplyr::filter(!(prov=="MAD")) %>% 
    dplyr::rename(trait=all_of(trait)) %>% 
    dplyr::select(prov,clon,tree,block,trait) %>% 
    drop_na() %>%  
    execute_if(CenterResponseVariable, mutate(trait=trait-mean(trait))) %>% 
    execute_if(LogResponseVariable, mutate(trait=log(trait))) %>% 
    arrange(by=tree) %>% 
    inner_join(drivers,by="prov")
  
  }
  
  
  # df %>% dplyr::select(prov,clon) %>% distinct()   %>% group_by(prov) %>% dplyr::summarise(count.clones=n()) %>% print(n=33)
  # df %>% select(prov,clon,trait) %>% group_by(prov) %>% summarise(mean=mean(trait)) %>% print(n=33)
  
  list.trait <- list(df=df)

#### Create the stan lists:
  list.stan <- lapply(colnames(drivers %>% dplyr::select(-prov)), function(x)    {
    list(N=length(df$tree),
         y=df$trait,
         X=as.numeric(pull(unique(df[,c(x,"prov")]) %>% dplyr::select(contains(x)))),
         nprov = length(unique(df$prov)),
         nclon = length(unique(df$clon)),
         nblock = length(unique(df$block)),
         prov = as.numeric(as.factor(df$prov)),
         which_prov = as.numeric(as.factor(pull(unique(df[c("prov","clon")])[,"prov"]))),
         clon = as.numeric(as.factor(df$clon)),
         bloc = as.numeric(as.factor(df$block)))})
  
  names(list.stan) <- colnames(drivers %>% dplyr::select(-prov))
  
  return(c(list.trait,list.stan))
}


ExtractParam <- function(x)  {
  readRDS(file=paste0("outputs/models/",x,".rds")) %>% 
  mclapply(function(x) broom::tidyMCMC(x,pars=param,
                droppars = NULL, 
                estimate.method = point.est, 
                ess = F, 
                rhat = F, 
                conf.int = T,
                conf.level = conf.level)) %>% 
  bind_rows() %>% 
  mutate(Xp=drivers,
         Traits=x)
}
```

# Running and saving the models

For each of the eight trait, we ran eight models, one for each potential drivers:

```{r RunModel,eval=F}
traits <- c("POR_htoct12","BDX_htnov13","BDX_htnov18","AST_htnov12","MeanBB","MeanDBB","POR_SLA","d13C")

for(trait in traits){
list.trait <- DownloadData(trait)

list.models <- list()

for(i in names(list.trait)[-1]){
  
  list.models[[i]] <- sampling(model, 
                               data = list.trait[[i]], 
                               pars=c("beta0","betaX",
                                      "pi","sigma2_r","sigma2_block","sigma2_prov","sigma2_clon",
                                      "h2_prov",
                                      "sigma_tot","sigma_block","sigma_prov",
                                      "mean_sigma_clon","sigma_clon","sigma_K",
                                      #"alpha_clon","alpha_prov",#"alpha_block",
                                      # "y_rep" not included not to have a too heavy file
                                      "R_squared","log_lik"),
                               iter = n_iter, 
                               chains = n_chains, 
                               cores = n_chains,
                               save_warmup = save_warmup,
                               thin=n_thin)
}

saveRDS(list.models,file=paste0("outputs/models/",trait,".rds"))

}
```

We use the `loo` package to compare the models based on the (ELPD)[http://mc-stan.org/loo/reference/loo-glossary.html].

```{r Loo,eval=F}
loos <- mclapply(list.models,loo)
loocompare <- loo_compare(x=loos)
saveRDS(loocompare,file=paste0("outputs/loo/",trait,".rds"))
```

# Posterior distributions

## $\beta_{X}$

### One graph per trait

```{r BetaXTraitSpecificFigure,eval=F}
drivers <- c("A","D","EH1[20km]","EH2[20km]","EH1[1.6km]","EH2[1.6km]","SHM","invEMT")# order in the model list, do not change
traits <- c("POR_htoct12","BDX_htnov13","BDX_htnov18","AST_htnov12","MeanBB","MeanDBB","POR_SLA","d13C")


mclapply(traits, function(x){
d <-readRDS(file=paste0("outputs/models/",x,".rds")) %>% 
  mclapply(function(x) broom::tidyMCMC(x,pars=("betaX"),
              droppars = NULL, 
              estimate.method = point.est, 
              ess = F, 
              rhat = F, 
              conf.int = T,
              conf.level = conf.level)) %>% 
  bind_rows() %>% 
  mutate(Xp=drivers)
  
d$Xp <- as.factor(d$Xp)
d$Xp <- factor(d$Xp,levels=c("A","D","EH1[1.6km]","EH2[1.6km]","EH1[20km]","EH2[20km]","invEMT","SHM"))


p <- ggplot(d,aes(x = Xp, y = estimate,ymin = conf.low, ymax = conf.high,color=Xp)) +
  geom_pointinterval(position = position_dodge(width = .6),point_size=5,size=5) +
  ylab(TeX("$\\beta_{X}$ estimates")) + xlab("") +
  scale_x_discrete(labels=c("A","D","EH1[1.6km]","EH2[1.6km]","EH1[20km]","EH2[20km]","invEMT","SHM")) +

  scale_color_manual(values=c("#7FBC41", "#4D9221" ,
                              "#DE77AE","#C51B7D" ,
                              "#B2ABD2", "#542788" , #"#2D004B","#8073AC" ,
                              "#E08214" ,"#FDB863" )) +
  #coord_flip() +
  theme_bw() +
  theme(axis.text = element_text(size=16),
        axis.title = element_text(size=16),
        legend.position = "none")


ggsave(p,file=paste0("figs/PosteriorDistributions/",x,"_BetaX.png"),height=8,width=12)

})
```

### Main figure of the paper (Figure 2) (5 drivers)


```{r}
traits <- c("BDX_htnov18","BDX_htnov13","POR_htoct12","AST_htnov12","MeanBB","MeanDBB","POR_SLA","d13C")
drivers <- c("A","D","EH1[20km]","EH2[20km]","EH1[1.6km]","EH2[1.6km]","SHM","invEMT")   
subdrivers <- c("A","EH1[20km]","EH2[20km]","SHM","invEMT")
param <- "betaX"

df.betaX <- mclapply(traits,ExtractParam)

df.betaX <- df.betaX %>% 
  bind_rows() %>%
  dplyr::filter(Xp %in% subdrivers) %>% 
  mutate(Hyp=case_when(Xp=="A"~"Admixture",
                       Xp=="D"~"Admixture",
                       Xp=="EH1[20km]"~"Environmental heterogeneity",
                       Xp=="EH2[20km]"~"Environmental heterogeneity",
                       Xp=="EH1[1.6km]"~"Environmental heterogeneity",
                       Xp=="EH2[1.6km]"~"Environmental heterogeneity",
                       Xp=="SHM"~"Climate harshness",
                       Xp=="invEMT"~"Climate harshness"),
         TraitType=case_when(Traits=="POR_htoct12"~"Morphological",
                             Traits=="BDX_htnov13"~"Morphological",
                             Traits=="AST_htnov12"~"Morphological",
                             Traits=="BDX_htnov18"~"Morphological",
                             Traits=="MeanBB"~"Phenological",
                             Traits=="MeanDBB"~"Phenological",
                             Traits=="POR_SLA"~"Functional",
                             Traits=="d13C"~"Functional"))


df.betaX$Traits <- as.factor(df.betaX$Traits)
levels(df.betaX$Traits)
df.betaX$Traits <- factor(df.betaX$Traits,levels=rev(c(traits)))
df.betaX$Xp <- as.factor(df.betaX$Xp)
df.betaX$Xp <- factor(df.betaX$Xp,levels=rev(levels(df.betaX$Xp)))

d13c <- parse(text = TeX("$\\delta^{13}C$"))

p <- df.betaX %>%   ggplot(aes(x = Xp, y = estimate,ymin = conf.low, ymax = conf.high,colour=Traits,shape=Traits)) +
  geom_pointinterval(position = position_dodge(width = .6),point_size=2.5,show.legend = c(size = TRUE)) +
  facet_grid(.~Hyp,scales="free", space = "free") + 
  ylab(TeX("$\\beta_{X}$ estimates")) + xlab("") +
  scale_colour_manual(labels = rev(c("Height (Bordeaux, 85 months)",
                                "Height (Bordeaux, 25 months)",
                                "Height (Fundão, 20 months)",
                                "Height (Asturias, 21 months)",
                                "Mean bud burst date",
                                "Mean duration of bud burst",
                                "Specific Leaf Area",
                                d13c)), # 
                     values=rev(c("#B2182B","#D73027","#F46D43", "#FDAE61","#5AAE61","#A6DBA0" ,"#4575B4", "#ABD9E9"))) +
  scale_shape_manual(labels = rev(c("Height (Bordeaux, 85 months)",
                                "Height (Bordeaux, 25 months)",
                                "Height (Fundão, 20 months)",
                                "Height (Asturias, 21 months)",
                                "Mean bud burst date",
                                "Mean duration of bud burst",
                                "Specific Leaf Area",
                                d13c)),
                     values = c(15, 15,17, 17,16,16,16,16)) +
  theme_bw() +
  theme(axis.text.x = element_text(size=13),
        axis.text.y = element_text(size=16),
        axis.title = element_text(size=16),
      legend.title=element_text(size=13), 
      legend.text=element_text(size=10),
      legend.position = c(.342, .13),
      legend.background = element_rect(colour = "grey"),
      strip.text.x = element_text(size = 14),
      panel.grid.minor.x=element_blank(),
      panel.grid.major.x=element_blank()) +
    guides(color=guide_legend(ncol=2))

ggsave(p, file="figs/PosteriorDistributions/ALLTRAITS_BetaX_PaperFig.png",height=8,width=10)
```


### Figure in Supp Info (5 drivers, all traits)


```{r AllTraits}
traits <- c("BDX_htnov18","BDX_htnov13","POR_htoct12","AST_htnov12","MeanBB","MeanDBB","POR_SLA","d13C")
drivers <- c("A","D","EH1[20km]","EH2[20km]","EH1[1.6km]","EH2[1.6km]","SHM","invEMT")   
param <- "betaX"

df.betaX <- mclapply(traits,ExtractParam)

df.betaX <- df.betaX %>% 
  bind_rows() %>%
  mutate(Hyp=case_when(Xp=="A"~"Admixture",
                       Xp=="D"~"Admixture",
                       Xp=="EH1[20km]"~"Environmental heterogeneity",
                       Xp=="EH2[20km]"~"Environmental heterogeneity",
                       Xp=="EH1[1.6km]"~"Environmental heterogeneity",
                       Xp=="EH2[1.6km]"~"Environmental heterogeneity",
                       Xp=="SHM"~"Climate harshness",
                       Xp=="invEMT"~"Climate harshness"),
         TraitType=case_when(Traits=="POR_htoct12"~"Morphological",
                             Traits=="BDX_htnov13"~"Morphological",
                             Traits=="AST_htnov12"~"Morphological",
                             Traits=="BDX_htnov18"~"Morphological",
                             Traits=="MeanBB"~"Phenological",
                             Traits=="MeanDBB"~"Phenological",
                             Traits=="POR_SLA"~"Functional",
                             Traits=="d13C"~"Functional"))


df.betaX$Traits <- as.factor(df.betaX$Traits)
levels(df.betaX$Traits)
df.betaX$Traits <- factor(df.betaX$Traits,levels=rev(c(traits)))
df.betaX$Xp <- as.factor(df.betaX$Xp)
df.betaX$Xp <- factor(df.betaX$Xp,levels=rev(levels(df.betaX$Xp)))

d13c <- parse(text = TeX("$\\delta^{13}C$"))

p <- df.betaX %>%   ggplot(aes(x = Xp, y = estimate,ymin = conf.low, ymax = conf.high,colour=Traits,shape=Traits)) +
  geom_pointinterval(position = position_dodge(width = .6),point_size=2.5,show.legend = c(size = TRUE)) +
  facet_grid(.~Hyp,scales="free", space = "free") + 
  ylab(TeX("$\\beta_{X}$ estimates")) + xlab("") +
  scale_colour_manual(labels = rev(c("Height (Bordeaux, 85 months)",
                                "Height (Bordeaux, 25 months)",
                                "Height (Fundão, 20 months)",
                                "Height (Asturias, 21 months)",
                                "Mean bud burst date",
                                "Mean duration of bud burst",
                                "Specific Leaf Area",
                                d13c)), # 
                     values=rev(c("#B2182B","#D73027","#F46D43", "#FDAE61","#5AAE61","#A6DBA0" ,"#4575B4", "#ABD9E9"))) +
  scale_shape_manual(labels = rev(c("Height (Bordeaux, 85 months)",
                                "Height (Bordeaux, 25 months)",
                                "Height (Fundão, 20 months)",
                                "Height (Asturias, 21 months)",
                                "Mean bud burst date",
                                "Mean duration of bud burst",
                                "Specific Leaf Area",
                                d13c)),
                     values = c(15, 15,17, 17,16,16,16,16)) +
  theme_bw() +
  theme(axis.text.x = element_text(size=13),
        axis.text.y = element_text(size=16),
        axis.title = element_text(size=16),
      legend.title=element_text(size=13), 
      legend.text=element_text(size=10),
      legend.position = c(.27, .13),
      legend.background = element_rect(colour = "grey"),
      strip.text.x = element_text(size = 14),
      panel.grid.minor.x=element_blank(),
      panel.grid.major.x=element_blank()) +
    guides(color=guide_legend(ncol=2))
p
ggsave(p, file="figs/PosteriorDistributions/ALLTRAITS_Alldrivers_BetaX.png",height=8,width=12)
```

### Other visualizations I tried

```{r BetaXAllTraitsFigure}
traits <- c("POR_htoct12","AST_htnov12","BDX_htnov13","BDX_htnov18","MeanBB","MeanDBB","POR_SLA","d13C")
drivers <- c("A","D","EH1[20km]","EH2[20km]","EH1[1.6km]","EH2[1.6km]","SHM","invEMT")    
param <- "betaX"

df.betaX <- mclapply(traits,ExtractParam) %>% bind_rows()

# Option 1
df.betaX$Traits <- as.factor(df.betaX$Traits)
df.betaX$Traits <- factor(df.betaX$Traits,levels=rev(c(traits)))
df.betaX$Xp <- as.factor(df.betaX$Xp)
df.betaX$Xp <- factor(df.betaX$Xp,levels=rev(levels(df.betaX$Xp)))


p <- df.betaX %>% 
  ggplot(aes(x = Xp, y = estimate,ymin = conf.low, ymax = conf.high,color=Traits)) +
  geom_pointinterval(position = position_dodge(width = .6),point_size=2) +
  ylab(TeX("$\\beta_{X}$ estimates")) + xlab("") +
  coord_flip() +
  scale_color_manual(values=rev(c("#B2182B","#D73027","#F46D43", "#FDAE61","#5AAE61","#A6DBA0" ,"#4575B4", "#ABD9E9")),
                     labels = rev(c("Height (Fundão, 20 months)",
                                "Height (Asturias, 21 months)",
                                "Height (Bordeaux, 25 months)",
                                "Height (Bordeaux, 85 months)",
                                "Mean bud burst date",
                                "Mean duration of bud burst",
                                "Specific Leaf Area",
                                parse(text = TeX("$\\delta^{13}C$")))
                     )) +
  theme_bw() +
  theme(axis.text = element_text(size=16),axis.title = element_text(size=16),
    legend.title=element_text(size=12), 
    legend.text=element_text(size=11),
    panel.grid.minor.y=element_blank(),
    panel.grid.major.y=element_blank()) +
    guides(color=guide_legend(reverse=TRUE))

p
ggsave(p, file="figs/PosteriorDistributions/ALLTRAITS_BetaX.png",height=10,width=10)


# Option 2
p <- df.betaX %>% 
  mutate(Hyp=case_when(Xp=="A"~"Admixture",
                       Xp=="D"~"Admixture",
                       Xp=="EH1[20km]"~"Environmental heterogeneity",
                       Xp=="EH2[20km]"~"Environmental heterogeneity",
                       Xp=="EH1[1.6km]"~"Environmental heterogeneity",
                       Xp=="EH2[1.6km]"~"Environmental heterogeneity",
                       Xp=="SHM"~"Climate harshness",
                       Xp=="invEMT"~"Climate harshness")) %>% 
  ggplot(aes(x = Xp, y = estimate,ymin = conf.low, ymax = conf.high,color=Traits)) +
  facet_grid(rows = vars(Hyp),scales="free", space = "free") +
  geom_pointinterval(position = position_dodge(width = .6),point_size=2) +
  ylab(TeX("$\\beta_{X}$ estimates")) + xlab("") +
  coord_flip() +
  scale_color_manual(values=rev(c("#B2182B","#D73027","#F46D43", "#FDAE61","#5AAE61","#A6DBA0" ,"#4575B4", "#ABD9E9")),
                     labels = rev(c("Height (Fundão, 20 months)",
                                "Height (Bordeaux, 25 months)",
                                "Height (Bordeaux, 85 months)",
                                "Height (Asturias, 21 months)",
                                "Mean bud burst date",
                                "Mean duration of bud burst",
                                "Specific Leaf Area",
                                parse(text = TeX("$\\delta^{13}C$")))
                     )) +
  theme_bw() +
  theme(axis.text = element_text(size=16),axis.title = element_text(size=16),
    legend.title=element_text(size=12), 
    legend.text=element_text(size=11),
    panel.grid.minor.y=element_blank(),
    panel.grid.major.y=element_blank()) +
    guides(color=guide_legend(reverse=TRUE))
p
ggsave(p, file="figs/PosteriorDistributions/ALLTRAITS_BetaX_FacetGrid.png",height=10,width=10)


df.betaX  <- df.betaX %>%
  mutate(Hyp=case_when(Xp=="A"~"Admixture",
                       Xp=="D"~"Admixture",
                       Xp=="EH1[20km]"~"Environmental heterogeneity",
                       Xp=="EH2[20km]"~"Environmental heterogeneity",
                       Xp=="EH1[1.6km]"~"Environmental heterogeneity",
                       Xp=="EH2[1.6km]"~"Environmental heterogeneity",
                       Xp=="SHM"~"Climate harshness",
                       Xp=="invEMT"~"Climate harshness"),
         TraitType=case_when(Traits=="POR_htoct12"~"Morphological",
                             Traits=="BDX_htnov13"~"Morphological",
                             Traits=="AST_htnov12"~"Morphological",
                             Traits=="BDX_htnov18"~"Morphological",
                             Traits=="MeanBB"~"Phenological",
                             Traits=="MeanDBB"~"Phenological",
                             Traits=="POR_SLA"~"Functional",
                             Traits=="d13C"~"Functional"))

# # Option 3
# 
# df.betaX$Xp <- factor(df.betaX$Xp,levels=rev(levels(df.betaX$Xp)))
# 
# pf.reverse <- df.betaX %>% 
#   ggplot(aes(x = Xp, y = estimate,ymin = conf.low, ymax = conf.high,color=Traits)) +
#   geom_pointinterval(position = position_dodge(width = .6),point_size=2.5) +
#   facet_grid(.~Hyp,scales="free", space = "free") + 
#   #facet_grid(~fct_relevel(Hyp,"Admixture","Climate harshness","Environmental heterogeneity"))
#   ylab(TeX("$\\beta_{X}$ estimates")) + xlab("") +
#   scale_color_manual(values=rev(c("#B2182B","#D73027","#F46D43", "#FDAE61","#5AAE61","#A6DBA0" ,"#4575B4", "#ABD9E9")),
#                      labels = rev(c("Height (Fundão, 20 months)",
#                                 "Height (Bordeaux, 25 months)",
#                                 "Height (Bordeaux, 85 months)",
#                                 "Height (Asturias, 21 months)",
#                                 "Specific Leaf Area",
#                                 "Mean bud burst date",
#                                 "Mean duration of bud burst",
#                                 parse(text = TeX("$\\delta^{13}C$")))
#                      )) +
#   theme_bw() +
#   theme(axis.text.x = element_text(size=10),
#         axis.text.y = element_text(size=16),
#         axis.title = element_text(size=16),
#         legend.title=element_text(size=12), 
#         strip.text.x = element_text(size = 14),
#         legend.text=element_text(size=9),
#         panel.grid.minor.x=element_blank(),
#         panel.grid.major.x=element_blank()) +
#     guides(color=guide_legend(reverse=TRUE))
#     
# ggsave(p, file="figs/PosteriorDistributions/ALLTRAITS_BetaX_FacetGrid_Reverse.png",height=8,width=14)

# Option 4
df.betaX$Xp <- factor(df.betaX$Xp,
                      levels=c("SHM","invEMT","EH1[20km]","EH1[1.6km]","EH2[20km]","EH2[1.6km]","D","A"))
df.betaX$Hyp <- as.factor(df.betaX$Hyp)
df.betaX$Hyp <- df.betaX$Hyp <- factor(df.betaX$Hyp,levels=c("Climate harshness","Admixture","Environmental heterogeneity"))


p <- df.betaX %>% 
  ggplot(aes(x = Xp, y = estimate,ymin = conf.low, ymax = conf.high,color=Traits)) +
  geom_pointinterval(position = position_dodge(width = .6),point_size=2.5) +
  facet_grid(.~Hyp,scales="free", space = "free") + 
  #facet_grid(~fct_relevel(Hyp,"Admixture","Climate harshness","Environmental heterogeneity"))
  ylab(TeX("$\\beta_{X}$ estimates")) + xlab("") +
  #coord_flip() +
  scale_color_manual(values=rev(c("#B2182B","#D73027","#F46D43", "#FDAE61","#5AAE61","#A6DBA0" ,"#4575B4", "#ABD9E9")),
                     labels = rev(c("Height (Fundão, 20 months)",
                                "Height (Bordeaux, 25 months)",
                                "Height (Bordeaux, 85 months)",
                                "Height (Asturias, 21 months)",
                                "Mean bud burst date",
                                "Mean duration of bud burst",
                                "Specific Leaf Area",
                                parse(text = TeX("$\\delta^{13}C$")))
                     )) +
  theme_bw() +
  theme(axis.text.x = element_text(size=13),
        axis.text.y = element_text(size=16),
        axis.title = element_text(size=16),
      legend.title=element_text(size=13), 
      legend.text=element_text(size=10),
      legend.position = c(.112, .19),
      legend.background = element_rect(colour = "grey"),
      strip.text.x = element_text(size = 14),
      panel.grid.minor.x=element_blank(),
      panel.grid.major.x=element_blank()) +
    guides(color=guide_legend(reverse=TRUE))
    
p

ggsave(p, file="figs/PosteriorDistributions/ALLTRAITS_BetaX_FacetGrid_Reverse_LegendBottomLeft.png",height=8,width=14)

df.betaX$Hyp <- factor(df.betaX$Xp,
                      levels=c("SHM","invEMT","EH1[20km]","EH1[1.6km]","EH2[20km]","EH2[1.6km]","D","A"))


# Option 5
# For the paper, figure with not all the drivers
p <- df.betaX %>% 
  dplyr::filter(!(Xp %in% c("D","EH1[1.6km]","EH2[1.6km]"))) %>% 
  ggplot(aes(x = Xp, y = estimate,ymin = conf.low, ymax = conf.high,color=Traits)) +
  geom_pointinterval(position = position_dodge(width = .6),point_size=2.5) +
  facet_grid(.~Hyp,scales="free", space = "free") + 
  #facet_grid(~fct_relevel(Hyp,"Admixture","Climate harshness","Environmental heterogeneity"))
  ylab(TeX("$\\beta_{X}$ estimates")) + xlab("") +
  #coord_flip() +
  scale_color_manual(values=rev(c("#B2182B","#D73027","#F46D43", "#FDAE61","#5AAE61","#A6DBA0" ,"#4575B4", "#ABD9E9")),
                     labels = rev(c("Height (Fundão, 20 months)",
                                "Height (Bordeaux, 25 months)",
                                "Height (Bordeaux, 85 months)",
                                "Height (Asturias, 21 months)",
                                "Mean bud burst date",
                                "Mean duration of bud burst",
                                "Specific Leaf Area",
                                parse(text = TeX("$\\delta^{13}C$")))
                     )) +
  theme_bw() +
  theme(axis.text.x = element_text(size=13),
        axis.text.y = element_text(size=16),
        axis.title = element_text(size=16),
      legend.title=element_text(size=13), 
      legend.text=element_text(size=10),
      legend.position = c(.142, .185),
      legend.background = element_rect(colour = "grey"),
      strip.text.x = element_text(size = 14),
      panel.grid.minor.x=element_blank(),
      panel.grid.major.x=element_blank()) +
    guides(color=guide_legend(reverse=TRUE))
    
p
ggsave(p, file="figs/PosteriorDistributions/ALLTRAITS_BetaX_FacetGrid_Reverse_LegendBottomLeft_5Drivers.png",
       height=8,width=10)
```


## $\sigma^{2}_{C_{p}}$

```{r SigmaClon}
traits <- c("POR_htoct12","BDX_htnov13","BDX_htnov18","AST_htnov12","MeanBB","MeanDBB","POR_SLA","d13C")
drivers <- c("A","D","EH1[20km]","EH2[20km]","EH1[1.6km]","EH2[1.6km]","SHM","invEMT") 

provs <- readRDS(file="data/ClonapinData/PhenoDataNovember2019_AnnualTraits.rds") %>% 
  dplyr::filter(!(prov=="MAD")) %>% 
  arrange(by=tree) %>% 
  distinct(prov) %>% 
  pull()

mclapply(traits,function(x){
if(x=="MeanBB"){
    legend.position <- c(0.85,0.86)} else {
    legend.position <- c(.15, .86)}
  
p <- readRDS(file=paste0("outputs/models/",x,".rds")) %>% 
  mclapply(function(x) {
    broom::tidyMCMC(x,pars=("sigma2_clon"),
                droppars = NULL, 
                estimate.method = point.est, 
                ess = F, 
                rhat = F, 
                conf.int = T,
                conf.level = conf.level)}) %>%  
  bind_rows(.id="Drivers") %>% 
  mutate(Traits=x,
         prov=rep(provs,8)) %>% 
  ggplot(aes(x = prov, y = estimate,ymin = conf.low, ymax = conf.high,color=Drivers)) +
  geom_pointinterval(position = position_dodge(width = .8),point_size=2,alpha=0.6,size=4) +
  scale_color_manual(values=c("#7FBC41", "#4D9221" ,
                              "#DE77AE","#C51B7D" ,
                              "#B2ABD2", "#542788" , #"#2D004B","#8073AC" ,
                              "#E08214" ,"#FDB863" ),
                     labels=c("A","D","EH1[1.6km]","EH2[1.6km]","EH1[20km]","EH2[20km]","invEMT","SHM")) +
  xlab("Populations") +
  ylab(TeX("$\\sigma^{2}_{C_{p}}$ estimates")) +
  labs(color = "Potential drivers") +
  theme(legend.position = legend.position,
        legend.background = element_rect(colour = "grey"),
        panel.grid.minor.x=element_blank(),
        panel.grid.major.x=element_blank())  +
    guides(color=guide_legend(ncol=4))

ggsave(p,file=paste0("figs/PosteriorDistributions/",x,"_SigmaClon.png"),height=6,width=22)
  
})

```

## Heritabilities

We calculated population-specific heritabilities, such as:

$$ h^2_{p} = \frac{\sigma^{2}_{C_{p}}}{\sigma^{2}_{C_{p}} + \sigma^{2}_r} $$

```{r H2Figures}
traits <- c("POR_htoct12","BDX_htnov13","BDX_htnov18","AST_htnov12","MeanBB","MeanDBB","POR_SLA","d13C")
drivers <- c("A","D","EH1[20km]","EH2[20km]","EH1[1.6km]","EH2[1.6km]","SHM","invEMT") 

provs <- readRDS(file="data/ClonapinData/PhenoDataNovember2019_AnnualTraits.rds") %>% 
  dplyr::filter(!(prov=="MAD")) %>% 
  arrange(by=tree) %>% 
  distinct(prov) %>% 
  pull()

mclapply(traits,function(x){
if(x=="MeanBB"){
    legend.position <- c(0.85,0.86)} else {
    legend.position <- c(.15, .86)}
  
p <- readRDS(file=paste0("outputs/models/",x,".rds")) %>% 
  mclapply(function(x) {
    broom::tidyMCMC(x,pars=("h2_prov"),
                droppars = NULL, 
                estimate.method = point.est, 
                ess = F, 
                rhat = F, 
                conf.int = T,
                conf.level = conf.level)}) %>%  
  bind_rows(.id="Drivers") %>% 
  mutate(Traits=x,
         prov=rep(provs,8)) %>% 
  ggplot(aes(x = prov, y = estimate,ymin = conf.low, ymax = conf.high,color=Drivers)) +
  geom_pointinterval(position = position_dodge(width = .8),point_size=2,alpha=0.6,size=4) +
  scale_color_manual(values=c("#7FBC41", "#4D9221" ,
                              "#DE77AE","#C51B7D" ,
                              "#B2ABD2", "#542788" , #"#2D004B","#8073AC" ,
                              "#E08214" ,"#FDB863" ),
                     labels=c("A","D","EH1[1.6km]","EH2[1.6km]","EH1[20km]","EH2[20km]","invEMT","SHM")) +
  xlab("Populations") +
  ylab(TeX("$\\H^{2}_{p}$ estimates")) +
  labs(color = "Potential drivers") +
  theme(legend.position = legend.position,
        legend.background = element_rect(colour = "grey"),
        panel.grid.minor.x=element_blank(),
        panel.grid.major.x=element_blank())  +
    guides(color=guide_legend(ncol=4))

ggsave(p,file=paste0("figs/PosteriorDistributions/",x,"_h2prov.png"),height=6,width=22)
  
})

```

```{r H2pheno}
# For the discussion, I calculated the heritability values of the phenology-related traits:
h2pheno <- mclapply(c("MeanBB","MeanDBB"),function(x){
  tab <- readRDS(file=paste0("outputs/models/",x,".rds")) %>% 
  mclapply(function(x) {
    broom::tidyMCMC(x,pars=("h2_prov"),
                droppars = NULL, 
                estimate.method = point.est, 
                ess = F, 
                rhat = F, 
                conf.int = T,
                conf.level = conf.level)}) %>%  
  bind_rows(.id="Drivers") %>% 
  mutate(Traits=x)
  
  mean(tab$estimate)
  })
```


## Variance partitioning


```{r VartPartFigs}
traits <- c("POR_htoct12","BDX_htnov13","BDX_htnov18","AST_htnov12","MeanBB","MeanDBB","POR_SLA","d13C")
drivers <- c("A","D","EH1[20km]","EH2[20km]","EH1[1.6km]","EH2[1.6km]","SHM","invEMT") 

mclapply(traits,function(x){
  p <- readRDS(file=paste0("outputs/models/",x,".rds")) %>% 
  mclapply(function(x) {
    broom::tidyMCMC(x,pars=("pi"),
                droppars = NULL, estimate.method = point.est, ess = F, rhat = F, conf.int = T,conf.level = 0.95)}) %>%  
  bind_rows(.id="Drivers") %>% 
  mutate(Traits=x,
         prop.var=rep(c("sigma_r","sigma_block","sigma_prov","mean_sigma_clon"),8)) %>% 
  
  ggplot(aes(x = prop.var, y = estimate,ymin = conf.low, ymax = conf.high,color=Drivers)) +
  geom_pointinterval(position = position_dodge(width = .8),point_size=3,alpha=0.6,size=5) +
  scale_color_manual(values=c("#7FBC41", "#4D9221" ,
                              "#DE77AE","#C51B7D" ,
                              "#B2ABD2", "#542788" , #"#2D004B","#8073AC" ,
                              "#E08214" ,"#FDB863" ),
                     labels=c("A","D","EH1[1.6km]","EH2[1.6km]","EH1[20km]","EH2[20km]","invEMT","SHM")) +
  xlab("") +
  ylab("Proportion of variance explained") +
  labs(color = "Potential drivers") +
  scale_x_discrete(labels=c("Clones",
                            "Blocks",
                            "Populations",
                            "Residuals"
                            )) +
  theme(legend.position = c(.135, .81),
        legend.background = element_rect(colour = "grey"),
        axis.text = element_text(size=25),
        panel.grid.minor.x=element_blank(),
        panel.grid.major.x=element_blank())  +
    guides(color=guide_legend(ncol=2))

ggsave(p,file=paste0("figs/PosteriorDistributions/",x,"_VarPart.png"),height=6,width=18)
  
})

```


```{r VarPartAllHeights}
traits <- c("POR_htoct12","BDX_htnov13","BDX_htnov18","AST_htnov12")
drivers <- c("A","EH1[20km]","EH2[20km]","SHM","invEMT") 

sigmas <- mclapply(traits,function(x){
  readRDS(file=paste0("outputs/models/",x,".rds")) %>% 
  mclapply(function(x) {
    broom::tidyMCMC(x,pars=("pi"),
                droppars = NULL, 
                estimate.method = point.est, 
                ess = F, rhat = F, 
                conf.int = T,
                conf.level = 0.95)}) %>%  
  bind_rows(.id="Drivers") %>% 
  mutate(Traits=x,
         prop.var=rep(c("sigma_r","sigma_block","sigma_prov","mean_sigma_clon"),8)) 
  
}) %>% 
  bind_rows() %>% 
  dplyr::filter(!(Drivers %in% c("D","EH.1km.PC1","EH.1km.PC2")))


maxylim <- 0.9
legend.text <- 20
line.size <- 10
point.size <- 5

p1 <- sigmas %>% 
  dplyr::filter(Traits=="POR_htoct12") %>% 
  ggplot(aes(x = prop.var, y = estimate,ymin = conf.low, ymax = conf.high,color=Drivers)) +
  geom_pointinterval(position = position_dodge(width = .8),point_size=point.size,alpha=0.6,size=line.size) +
  scale_color_manual(values=c("#7FBC41",
                              "#B2ABD2", "#542788" , #"#2D004B","#8073AC" ,
                              "#E08214" ,"#FDB863" ),
                     labels=c("A","EH1[20km]","EH2[20km]","invEMT","SHM")) +
  xlab("") +
  ylim(0,maxylim) +
  ylab("Proportion of variance explained") +
  labs(color = "Potential drivers") +
  scale_x_discrete(labels=c("Clones",
                            "Blocks",
                            "Populations",
                            "Residuals"
                            )) +
  theme(legend.position = c(.2, .73),
        legend.text = element_text(size=legend.text,margin = margin(t = 10)),
        legend.background = element_rect(colour = "grey"),
        axis.text = element_text(size=22),
        panel.grid.minor.x=element_blank(),
        panel.grid.major.x=element_blank())  +
    guides(color=guide_legend(ncol=1))

p2 <- sigmas %>% 
  dplyr::filter(Traits=="BDX_htnov13") %>% 
  ggplot(aes(x = prop.var, y = estimate,ymin = conf.low, ymax = conf.high,color=Drivers)) +
  geom_pointinterval(position = position_dodge(width = .8),point_size=point.size,alpha=0.6,size=line.size) +
  scale_color_manual(values=c("#7FBC41",
                              "#B2ABD2", "#542788" , #"#2D004B","#8073AC" ,
                              "#E08214" ,"#FDB863" ),
                     labels=c("A","EH1[20km]","EH2[20km]","invEMT","SHM")) +
  xlab("") +
  ylab("") +
  ylim(0,maxylim) +
  labs(color = "Potential drivers") +
  scale_x_discrete(labels=c("Clones",
                            "Blocks",
                            "Populations",
                            "Residuals"
                            )) +
  theme(legend.position = "none",
        axis.text = element_text(size=22),
        panel.grid.minor.x=element_blank(),
        panel.grid.major.x=element_blank())  +
    guides(color=guide_legend(ncol=1))


p3 <- sigmas %>% 
  dplyr::filter(Traits=="BDX_htnov18") %>% 
  ggplot(aes(x = prop.var, y = estimate,ymin = conf.low, ymax = conf.high,color=Drivers)) +
  geom_pointinterval(position = position_dodge(width = .8),point_size=point.size,alpha=0.6,size=line.size) +
  scale_color_manual(values=c("#7FBC41",
                              "#B2ABD2", "#542788" , #"#2D004B","#8073AC" ,
                              "#E08214" ,"#FDB863" ),
                     labels=c("A","EH1[20km]","EH2[20km]","invEMT","SHM")) +
  xlab("") +
  ylim(0,maxylim) +
  ylab("Proportion of variance explained") +
  labs(color = "Potential drivers") +
  scale_x_discrete(labels=c("Clones",
                            "Blocks",
                            "Populations",
                            "Residuals"
                            )) +
  theme(legend.position = "none",
        axis.text = element_text(size=22),
        panel.grid.minor.x=element_blank(),
        panel.grid.major.x=element_blank())  +
    guides(color=guide_legend(ncol=1))

p4 <- sigmas %>% 
  dplyr::filter(Traits=="AST_htnov12") %>% 
  ggplot(aes(x = prop.var, y = estimate,ymin = conf.low, ymax = conf.high,color=Drivers)) +
  geom_pointinterval(position = position_dodge(width = .8),point_size=point.size,alpha=0.6,size=line.size) +
  scale_color_manual(values=c("#7FBC41",
                              "#B2ABD2", "#542788" , #"#2D004B","#8073AC" ,
                              "#E08214" ,"#FDB863" ),
                     labels=c("A","EH1[20km]","EH2[20km]","invEMT","SHM")) +
  xlab("") +
  ylab("") +
  ylim(0,maxylim) +
  labs(color = "Potential drivers") +
  scale_x_discrete(labels=c("Clones",
                            "Blocks",
                            "Populations",
                            "Residuals"
                            )) +
  theme(legend.position = "none",
        axis.text = element_text(size=22),
        panel.grid.minor.x=element_blank(),
        panel.grid.major.x=element_blank())  +
    guides(color=guide_legend(ncol=1))

p <- plot_grid(p1,p2,p3,p4,
          labels = c('A)','B)',"C)","D)"),
                 label_size = 20 )

ggsave(p,file=paste0("figs/PosteriorDistributions/VarPart_AllHeights.png"),height=14,width=17)
  
```


## $\mathcal{R}^{2}$


```{r RsquaredPosteriors}
traits <- c("POR_htoct12","BDX_htnov13","BDX_htnov18","AST_htnov12","MeanBB","MeanDBB","POR_SLA","d13C")
drivers <- c("A","D","EH1[20km]","EH2[20km]","EH1[1.6km]","EH2[1.6km]","SHM","invEMT")    
param <- "R_squared"

df <- traits %>% 
  mclapply(ExtractParam) %>% 
  bind_rows() %>%
  mutate(trait.class=case_when(Traits=="POR_htoct12"~"Height",
                       Traits=="BDX_htnov13"~"Height",
                       Traits=="BDX_htnov18"~"Height",
                       Traits=="AST_htnov12"~"Height",
                       Traits=="MeanBB"~"Phenology",
                       Traits=="MeanDBB"~"Phenology",
                       Traits=="POR_SLA"~"Functional traits",
                       Traits=="d13C"~"Functional traits"),
         trait.names=case_when(Traits=="POR_htoct12"~"Fundão 20m",
                       Traits=="BDX_htnov13"~"Bordeaux 25m",
                       Traits=="BDX_htnov18"~"Bordeaux 85m",
                       Traits=="AST_htnov12"~"Asturias 21m",
                       Traits=="MeanBB"~"MeanBB",
                       Traits=="MeanDBB"~"MeanDBB",
                       Traits=="POR_SLA"~"SLA",
                       Traits=="d13C"~"d13C"))

df$Traits <- as.factor(df$Traits)
df$Traits <- factor(df$Traits,levels=c(traits))
df$Xp <- as.factor(df$Xp)
df$Xp <- factor(df$Xp,levels=rev(c("A","D","EH1[1.6km]","EH2[1.6km]","EH1[20km]","EH2[20km]","invEMT","SHM")))

p <- df %>% 
  ggplot(aes(x = trait.names, y = estimate,ymin = conf.low, ymax = conf.high,color=Xp)) +
  geom_pointinterval(position = position_dodge(width = .6),point_size=2.5,alpha=0.6) +
  facet_grid(.~trait.class,scales="free", space = "free") + 
  #facet_grid(~fct_relevel(Hyp,"Admixture","Climate harshness","Environmental heterogeneity"))
  ylab(TeX("$R^{2}$")) + xlab("") +
  labs(color = "Potential drivers") +
  scale_color_manual(values=rev(c("#7FBC41", "#4D9221" ,
                              "#DE77AE","#C51B7D" ,
                              "#B2ABD2", "#542788" , #"#2D004B","#8073AC" ,
                              "#E08214" ,"#FDB863" ))) +
  theme_bw() +
  theme(axis.text.x = element_text(size=13),
        axis.text.y = element_text(size=16),
        axis.title = element_text(size=16),
      legend.title=element_text(size=13), 
      legend.text=element_text(size=10),
      legend.position = c(.88, .19),
      legend.background = element_rect(colour = "grey"),
      strip.text.x = element_text(size = 14),
      panel.grid.minor.x=element_blank(),
      panel.grid.major.x=element_blank()) +
    guides(color=guide_legend(ncol=2))
    
p

ggsave(p, file="figs/PosteriorDistributions/ALLTRAITS_Rsquared.png",height=7,width=12)
```



# Correlation btw the number of clones per pop and $\sigma^{2}_{C_{p}}$

```{r CorrealtionNumberClones}
traits <- c("POR_htoct12","BDX_htnov13","BDX_htnov18","AST_htnov12","MeanBB","MeanDBB","POR_SLA","d13C")

provs <- readRDS(file="data/ClonapinData/PhenoDataNovember2019_AnnualTraits.rds") %>% 
  dplyr::filter(!(prov=="MAD")) %>% 
  arrange(by=tree) %>% 
  distinct(prov) %>% 
  pull()

# Extrating the sigma2_clon (i.e. within-population genetic variation)
sigma2_clon <- mclapply(traits,function(x){
  
  readRDS(file=paste0("outputs/models/",x,".rds")) %>% 
  mclapply(function(x) {
    broom::tidyMCMC(x,pars=("sigma2_clon"),
                droppars = NULL, 
                estimate.method = point.est, 
                ess = F, 
                rhat = F, 
                conf.int = T,
                conf.level = conf.level)}) %>%  
  bind_rows(.id="Drivers") %>% 
  mutate(Traits=x,
         prov=rep(provs,8)) }) %>% 
    setNames(traits)


# Extracting the number of clones per population
NbClonePerProv <- function(trait){

  drivers <- readRDS(file="data/DF_Drivers.rds") %>% 
    dplyr::select(prov,A,D,EH.20km.PC1,EH.20km.PC2,EH.1km.PC1,EH.1km.PC2,SHM,invEMT) %>% 
    dplyr::mutate(across(-prov,scale))
  
  if(trait=="MeanBB"|trait=="MeanDBB"){
      
  df <- readRDS(file="data/ClonapinData/PhenoDataNovember2019_AnnualTraits.rds") %>% 
    dplyr::filter(!(prov=="MAD")) %>% 
    when(trait=="MeanBB" ~ dplyr::select(.,prov,clon,tree,block,BDX_s32013,BDX_s32014,BDX_s32015,BDX_s32017),
         ~ dplyr::select(.,prov,clon,tree,block,BDX_dbb2014,BDX_dbb2015,BDX_dbb2017)) %>% 
    filter(rowSums(is.na(across(where(is.numeric)))) != ncol(.)-4) %>% 
    dplyr::select(prov,clon) %>% 
    distinct(.) %>% 
    group_by(prov) %>% 
    dplyr::summarise(count=n())
  
  } else {
    
  df <- readRDS(file="data/ClonapinData/PhenoDataNovember2019_AnnualTraits.rds") %>% 
    dplyr::filter(!(prov=="MAD")) %>% 
    dplyr::rename(trait=all_of(trait)) %>% 
    dplyr::select(prov,clon,tree,block,trait) %>% 
    drop_na() %>%  
    dplyr::select(prov,clon) %>% 
    distinct(.) %>% 
    group_by(prov) %>% 
    dplyr::summarise(count=n())
  
  }}

count <- mclapply(traits,NbClonePerProv) %>% setNames(traits)

drivers <- c("A","D", "EH.20km.PC1","EH.20km.PC2","EH.1km.PC1","EH.1km.PC2","SHM","invEMT") 

df <- mclapply(traits, function(x){
  mclapply(drivers,function(driver)
  cor(count[[x]]$count,sigma2_clon[[x]]$estimate[sigma2_clon[[x]]$Drivers==driver])
  ) %>% 
  setNames(drivers)
}) %>% 
  setNames(traits) %>% 
  bind_rows(.id="Traits") %>% 
  gather(Driver, val, 2:ncol(.)) %>%
  spread(Traits, val) %>% 
  dplyr::select(Driver,POR_htoct12,BDX_htnov13,BDX_htnov18,AST_htnov12,MeanBB ,MeanDBB, POR_SLA, d13C) %>% 
  dplyr::mutate(Driver=c("A","D","EH1[1.6km]","EH2[1.6km]","EH1[20km]","EH2[20km]","invEMT","SHM"))


# Get the table in latex for the Supplementary Information
df %>% kable(digits=3,"latex")
```


# Climatic transfer distances

```{r FunctionDownloadDataCTD}
DownloadDataCTD <- function(trait){

if(trait=="MeanBB"|trait=="MeanDBB"|trait=="d13C"){
    CenterResponseVariable <- TRUE
    LogResponseVariable <- FALSE
    
  }  else if(trait=="POR_SLA"){
    CenterResponseVariable <- FALSE
    LogResponseVariable <- TRUE
  } else {
    CenterResponseVariable <- FALSE
    LogResponseVariable <- FALSE
  }
  
  drivers <- readRDS(file="data/DF_Drivers.rds") %>% 
    dplyr::select(prov,contains("_EMT"),contains("_SHM")) %>% 
    dplyr::mutate(dplyr::across(-prov,scale))
  
  if(trait=="MeanBB"|trait=="MeanDBB"){
    
  df <- readRDS(file="data/ClonapinData/PhenoDataNovember2019_AnnualTraits.rds") %>% 
    dplyr::filter(!(prov=="MAD")) %>% 
    when(trait=="MeanBB" ~ dplyr::select(.,prov,clon,tree,block,BDX_s32013,BDX_s32014,BDX_s32015,BDX_s32017),
         ~ dplyr::select(.,prov,clon,tree,block,BDX_dbb2014,BDX_dbb2015,BDX_dbb2017)) %>% 
    filter(rowSums(is.na(across(where(is.numeric)))) != ncol(.)-4) %>% 
    dplyr::mutate(trait = rowMeans(dplyr::select(.,contains("BDX")),na.rm=T)) %>%
    execute_if(CenterResponseVariable, mutate(trait=trait-mean(trait))) %>% 
    execute_if(LogResponseVariable, mutate(trait=log(trait))) %>% 
    arrange(by=tree) %>% 
    inner_join(drivers,by="prov") 
  
  } else {
    
  df <- readRDS(file="data/ClonapinData/PhenoDataNovember2019_AnnualTraits.rds") %>% 
    dplyr::filter(!(prov=="MAD")) %>% 
    dplyr::rename(trait=all_of(trait)) %>% 
    dplyr::select(prov,clon,tree,block,trait) %>% 
    drop_na() %>%  
    execute_if(CenterResponseVariable, mutate(trait=trait-mean(trait))) %>% 
    execute_if(LogResponseVariable, mutate(trait=log(trait))) %>% 
    arrange(by=tree) %>% 
    inner_join(drivers,by="prov")
  
  }
  
  # Depending on the site where the traits were measured, we do not use the same CTD
  if(trait %in% c("MeanBB","MeanDBB","BDX_htnov18","BDX_htnov13")) CTD <- c("CTD_bordeaux_EMT","CTD_bordeaux_SHM")
  if(trait %in% c("POR_SLA","d13C","POR_htoct12")) CTD <- c("CTD_portugal_EMT","CTD_portugal_SHM")
  if(trait == "AST_htnov12") CTD <- c("CTD_asturias_EMT","CTD_asturias_SHM")
  
  list.stan <- lapply(CTD, function(x)    {
    list(N=length(df$tree),
         y=df$trait,
         X=as.numeric(pull(unique(df[,c(x,"prov")]) %>% dplyr::select(contains(x)))),
         nprov = length(unique(df$prov)),
         nclon = length(unique(df$clon)),
         nblock = length(unique(df$block)),
         prov = as.numeric(as.factor(df$prov)),
         which_prov = as.numeric(as.factor(pull(unique(df[c("prov","clon")])[,"prov"]))),
         clon = as.numeric(as.factor(df$clon)),
         bloc = as.numeric(as.factor(df$block)))})
  
  names(list.stan) <- CTD
  
  return(list.stan)
}
```

```{r RunningModelsCTD}
traits <- c("POR_htoct12","BDX_htnov13","BDX_htnov18","AST_htnov12","MeanBB","MeanDBB","POR_SLA","d13C")

CTDbetaX <- lapply(traits, function(trait) {
  
  list.stan <- DownloadDataCTD(trait)
  
  
  output <- lapply(names(list.stan), function(x){
    
    mod <- sampling(model, 
                  data = list.stan[[x]], 
                  pars=c("betaX"),
                  iter = n_iter, 
                  chains = n_chains, 
                  cores = n_chains,
                  save_warmup = save_warmup,
                  thin=n_thin)
  
    broom::tidyMCMC(mod,pars=(c("betaX")),
                  droppars = NULL, estimate.method = "median", ess = T, rhat = T, conf.int = T,conf.level = 0.95) %>% 
      dplyr::mutate(driver=x)
    
  }) %>% bind_rows
  
  
  })

names(CTDbetaX) <- traits
CTDbetaX %>% bind_rows(.id="Trait")

saveRDS(CTDbetaX,file=paste0("outputs/models/CTDbetaX.rds"))
```


```{r FigureCTD}
CTDbetaX <- readRDS(file=paste0("outputs/models/CTDbetaX.rds"))

traits <- c("BDX_htnov18","BDX_htnov13","POR_htoct12","AST_htnov12","MeanBB","MeanDBB","POR_SLA","d13C")

CTDbetaX <- 
  CTDbetaX %>% 
  bind_rows(.id="Traits") %>%
  mutate(driver=paste0("CMT(",str_sub(driver,-3),")"))

CTDbetaX $Traits <- as.factor(CTDbetaX $Traits)
CTDbetaX $Traits <- factor(CTDbetaX $Traits,levels=rev(c(traits)))

d13c <- parse(text = TeX("$\\delta^{13}C$"))

p <- CTDbetaX  %>%   ggplot(aes(x = driver, y = estimate,ymin = conf.low, ymax = conf.high,colour=Traits,shape=Traits)) +
  geom_pointinterval(position = position_dodge(width = .6),point_size=2.5,size=3,show.legend = c(size = TRUE)) +
  #facet_grid(.~Hyp,scales="free", space = "free") + 
  ylab(TeX("$\\beta_{X}$ estimates")) + xlab("") +
  scale_colour_manual(labels = rev(c("Height (Bordeaux, 85 months)",
                                "Height (Bordeaux, 25 months)",
                                "Height (Fundão, 20 months)",
                                "Height (Asturias, 21 months)",
                                "Mean bud burst date",
                                "Mean duration of bud burst",
                                "Specific Leaf Area",
                                d13c)), # 
                     values=rev(c("#B2182B","#D73027","#F46D43", "#FDAE61","#5AAE61","#A6DBA0" ,"#4575B4", "#ABD9E9"))) +
  scale_shape_manual(labels = rev(c("Height (Bordeaux, 85 months)",
                                "Height (Bordeaux, 25 months)",
                                "Height (Fundão, 20 months)",
                                "Height (Asturias, 21 months)",
                                "Mean bud burst date",
                                "Mean duration of bud burst",
                                "Specific Leaf Area",
                                d13c)),
                     values = c(15, 15,17, 17,16,16,16,16)) +
  theme_bw() +
  theme(axis.text.x = element_text(size=13),
        axis.text.y = element_text(size=16),
        axis.title = element_text(size=16),
      legend.title=element_text(size=13), 
      legend.text=element_text(size=10),
      legend.position = c(0.83,0.84),#c(.37, .16),
      legend.background = element_rect(colour = "grey"),
      strip.text.x = element_text(size = 14),
      panel.grid.minor.x=element_blank(),
      panel.grid.major.x=element_blank()) +
    guides(color=guide_legend(ncol=1,override.aes = list(size=2)))
p

ggsave(p,file="figs/PosteriorDistributions/CTD.png",height=9,width=9)
```

