---
title: "Exploratoy analyses on the eight phenotypic traits under study"
author: "Juliette Archambeau"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    # code_fold: hide
    toc: true
    toc_depth: 4
    toc_float:
       collapsed: false
    number_sections: true
    highlight: textmate
editor_options: 
  chunk_output_type: console
---

<style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;
  white-space: pre;
}
</style>

<style type="text/css">
div.main-container {
  max-width: 2000px;
  margin-left: auto;
  margin-right: auto;
}
</style>


```{css, echo=FALSE}
pre {
  max-height: 300px;
  overflow-y: auto;
}

pre[class] {
  max-height: 600px;
}
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 5,fig.height = 4,cache=FALSE)
options(knitr.table.format = "latex",width = 300)
library(knitr)      # CRAN v1.26
library(dplyr)      # CRAN v1.0.0
library(tidyverse)  # CRAN v1.3.0
library(latex2exp)  # CRAN v0.4.0
library(cowplot)    # CRAN v1.0.0
library(kableExtra) # CRAN v1.1.0
library(grid)
library(parallel)
```

```{r Options}
# Options
ncol.wrap <- 7
x.wrap <- 0.85
y.wrap <- 0.09
height.wrap <- 10
width.wrap <- 14
```


Traits selected in this study:

  - Height:
      
      - In Portugal (Fundão): height in October 2012 when the trees were 20-month old.
      
      - In Asturias(Cabada, Spain): height in November 2012 when the trees were 21-month old.
      
      - In Bordeaux (Pierroton, France):  height in November 2013 when the trees were 25-month old & in November 2018 when the trees were 85-month old.
    
  - Phenology:
      
      - mean bud burst (=date of brachybalst emergence) over four years (2013, 2014, 2015 and 2017) in Bordeaux (°C-day)
      
      - mean duration of bud burst (in 2014)2014, 2015 and 2017) in Bordeaux (°C-day)
      
  - Functional traits
  
     - $\delta^{13}C$
     
     - Specific Leaf Area (SLA)


In the document, the plots colored in green correspond to the trait selected in the study.

```{r LoadDriversAndTraitData}
# Load data
drivers <- readRDS(file="data/DF_Drivers.rds") %>% 
    dplyr::select(prov,A,D,EH.20km.PC1,EH.20km.PC2,EH.1km.PC1,EH.1km.PC2,SHM,EMT)

data <- readRDS(file="data/ClonapinData/PhenoDataNovember2019_AnnualTraits.rds") %>% 
   dplyr::filter(!(prov=="MAD")) %>% 
  inner_join(drivers,by="prov")
```


# Height


```{r HeightNAs}
data %>% dplyr::select(contains("ht")) %>% summary
```

## Bordeaux (France) - November 2013 and 2018

### All height values

```{r BBhistBordeaux, fig.height=10,fig.width=10,warning=F}
plot_grid(
ggplot(data, aes(x= BDX_htnov13)) + 
  geom_histogram(binwidth = 20, fill="seagreen3") +  
  theme_bw() + 
  labs(x="Height 2013",y="") +
  annotate("text",x=1500,y=150,label=paste0("Var = ",round(var(data$BDX_htnov13,na.rm=T),2))),

ggplot(data, aes(x= BDX_htnov14)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() + 
  labs(x="Height 2014",y="") +
  annotate("text",x=2300,y=80,label=paste0("Var = ",round(var(data$BDX_htnov14,na.rm=T),2))),

ggplot(data, aes(x= BDX_htnov15)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() +
  labs(x="Height 2015",y="") +
  annotate("text",x=3000,y=60,label=paste0("Var = ",round(var(data$BDX_htnov15,na.rm=T),2))),

ggplot(data, aes(x= BDX_htnov18)) + 
  geom_histogram(binwidth = 20, fill="seagreen3") +  
  theme_bw() + 
  labs(x="Height 2018",y="") +
  annotate("text",x=6500,y=50,label=paste0("Var = ",round(var(data$BDX_htnov18,na.rm=T),2))))
```

### Height values per provenances

#### Height - 25-month old - November 2013

```{r BDX2013HeightOLD, fig.height=10,fig.width=12,warning=F,message=F,eval=F,echo=F}
# Per provenance
# --------------

# Provenances colored according to their main gene pool (the gene pool for which the provenances have the highest proportion of belonging)

p <- ggplot(data, aes(x=BDX_htnov13, fill=as.factor(prov))) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(prov)) + 
  scale_fill_manual(values=c("turquoise2",
                              "turquoise2",
                              "darkorchid3",
                              "darkorchid3",
                              "darkorchid3",
                              "turquoise2",
                              
                              "darkorchid3",
                              "turquoise2",
                              "darkorchid3",
                              "darkorchid3",
                              "green3",
                              "darkorchid3",
                              
                              "navyblue",
                              "turquoise2",
                              "darkorchid3",
                              # "orangered3", # no MAD in Bordeaux
                              "navyblue",
                              "darkorchid3",
                              
                              "navyblue",
                              "green3",
                              "navyblue",
                              "gold2",
                              "gold2",
                              "navyblue",
                              
                              "turquoise2",
                              "darkorchid3",
                              "turquoise2",
                              "darkorchid3",
                              "turquoise2",
                              "turquoise2",
                              
                              "navyblue",
                              "orangered3",
                              "darkorchid3",
                              "navyblue")) +
  labs(x="",y="") +
  theme(legend.position = "none")

p
ggsave(p,file="figs/ExploratoryAnalyses/HeightBordeaux2013.png",height=10,width=12)
```

```{r BDX2013HeightGP, fig.height=10,fig.width=12,warning=F,message=F}
# Per provenance
# --------------

# Clones are colored according to the main gene pool (the gene pool for which the provenances have the highest proportion of belonging)

p <- ggplot(data, aes(x=BDX_htnov13, fill=as.factor(max.Q))) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(prov)) + 
  scale_fill_manual(values=c("orangered3",   # Northern Africa
                              "gold2",       # Corsica
                              "darkorchid3", # Central Spain
                              "navyblue",    # French Atlantic
                              "turquoise2",  # Iberian Atlantic
                              "green3"       # South-eastern Spain
                             ),
                    labels=c("Northern Africa", 
                             "Corsica",
                             "Central Spain",
                             "French Atlantic",
                             "Iberian Atlantic",
                             "South-eastern Spain")
                    ,name="Gene pools") +
  labs(x="",y="") +
  theme(legend.position = c(0.75, 0.07),
        legend.text = element_text(size=12),
        legend.title = element_text(size=14)) + 
  guides(fill=guide_legend(nrow=2))

p
ggsave(p,file="figs/ExploratoryAnalyses/HeightBordeaux2013.png",height=10,width=12)
```


```{r BDX2013HeightEMT, fig.height=10,fig.width=12,warning=F,message=F}
# Per provenance
# --------------

# Provenances are colored according to the value of EMT in their location

p <- ggplot(data, aes(x=BDX_htnov13, fill=EMT)) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(prov), ncol = ncol.wrap) +
  labs(x="",y="") +
  scale_fill_gradient2(midpoint = mean(data$EMT,na.rm=T), 
                        low = "blue",  
                        mid = "yellow",
                        high = "red",
                        space = "Lab" ,
                       name="Extreme minimum temperature") +
  theme(legend.position = c(x.wrap,y.wrap),
        legend.text = element_text(size=10),
        legend.title = element_text(size=12))

p
ggsave(p,file="figs/ExploratoryAnalyses/HeightBordeaux2013_EMTgradient.png",height=height.wrap,width=width.wrap)
```

#### Height - 85-month old - November 2018

```{r BDX2018HeightGP, fig.height=10,fig.width=12,warning=F,message=F}
# Per provenance
# --------------

# Clones are colored according to the main gene pool (the gene pool for which the provenances have the highest proportion of belonging)

p <- ggplot(data, aes(x=BDX_htnov18, fill=as.factor(max.Q))) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(prov)) + 
  scale_fill_manual(values=c("orangered3", # Nprthern Africa
                              "gold2",# Corsica
                              "darkorchid3", # Central Spain
                              "navyblue", # french Atlantic
                              "turquoise2", # Iberian Atlantic
                              "green3" # South-eastern Spain
                             ),
                    labels=c("Northern Africa", 
                             "Corsica",
                             "Central Spain",
                             "French Atlantic",
                             "Iberian Atlantic",
                             "South-eastern Spain")
                    ,name="Gene pools") +
  labs(x="",y="") +
  theme(legend.position = c(0.75, 0.07),
        legend.text = element_text(size=12),
        legend.title = element_text(size=14)) + 
  guides(fill=guide_legend(nrow=2))
p
ggsave(p,file="figs/ExploratoryAnalyses/HeightBordeaux2018.png",height=10,width=12)
```



```{r BDX2018HeightEMT, fig.height=10,fig.width=12,warning=F,message=F}
# Per provenance
# --------------

# Provenances are colored according to the value of EMT in their location

p <- ggplot(data, aes(x=BDX_htnov18, fill=EMT)) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(prov), ncol = ncol.wrap) +
  labs(x="",y="") +
  scale_fill_gradient2(midpoint = mean(data$EMT,na.rm=T), 
                        low = "blue",  
                        mid = "yellow",
                        high = "red",
                        space = "Lab" ,
                       name="Extreme minimum temperature") +
  theme(legend.position = c(x.wrap,y.wrap),
        legend.text = element_text(size=10),
        legend.title = element_text(size=12))

p
ggsave(p,file="figs/ExploratoryAnalyses/HeightBordeaux2018_EMTgradient.png",height=height.wrap,width=width.wrap)
```



## Cabada (Asturias, Spain) - November 2012

### All height values

```{r BBhistCabada, fig.height=10,fig.width=10,warning=F}
plot_grid(
ggplot(data, aes(x= AST_htdec11)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() + 
  labs(x="Height - December 2011",y="") +
  annotate("text",x=580,y=300,label=paste0("Var = ",round(var(data$BDX_htnov13,na.rm=T),2))),

ggplot(data, aes(x= AST_htnov12)) + 
  geom_histogram(binwidth = 20, fill="seagreen3") +  
  theme_bw() + 
  labs(x="Height - November 2012",y="") +
  annotate("text",x=1200,y=150,label=paste0("Var = ",round(var(data$BDX_htnov14,na.rm=T),2))),

ggplot(data, aes(x= AST_htmar14)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() +
  labs(x="Height - March 2014",y="") +
  annotate("text",x=2100,y=100,label=paste0("Var = ",round(var(data$BDX_htnov15,na.rm=T),2))))
```

### Height values per provenances

```{r AST2012HeightGP, fig.height=10,fig.width=12,warning=F,message=F}
# Per provenance
# --------------

# Clones are colored according to the main gene pool (the gene pool for which the provenances have the highest proportion of belonging)

p <- ggplot(data, aes(x=AST_htnov12, fill=as.factor(max.Q))) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(prov)) + 
  scale_fill_manual(values=c("orangered3",   # Northern Africa
                              "gold2",       # Corsica
                              "darkorchid3", # Central Spain
                              "navyblue",    # French Atlantic
                              "turquoise2",  # Iberian Atlantic
                              "green3"       # South-eastern Spain
                             ),
                    labels=c("Northern Africa", 
                             "Corsica",
                             "Central Spain",
                             "French Atlantic",
                             "Iberian Atlantic",
                             "South-eastern Spain")
                    ,name="Gene pools") +
  labs(x="",y="") +
  theme(legend.position = c(0.75, 0.07),
        legend.text = element_text(size=12),
        legend.title = element_text(size=14)) + 
  guides(fill=guide_legend(nrow=2))

p
ggsave(p,file="figs/ExploratoryAnalyses/HeightAsturias2012.png",height=10,width=12)
```

```{r AST2012HeightEMT, fig.height=10,fig.width=12,warning=F,message=F}
# Per provenance
# --------------

# Provenances are colored according to the value of EMT in their location

p <- ggplot(data, aes(x=AST_htnov12, fill=EMT)) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(prov), ncol = ncol.wrap) +
  labs(x="",y="") +
  scale_fill_gradient2(midpoint = mean(data$EMT,na.rm=T), 
                        low = "blue",  
                        mid = "yellow",
                        high = "red",
                        space = "Lab" ,
                       name="Extreme minimum temperature") +
  theme(legend.position = c(x.wrap,y.wrap),
        legend.text = element_text(size=10),
        legend.title = element_text(size=12))

p
ggsave(p,file="figs/ExploratoryAnalyses/HeightAsturias2012_EMTgradient.png",height=height.wrap,width=width.wrap)
```


## Portugal (Fundão) - October 2012

### All height values

```{r BBhistFundao, fig.height=10,fig.width=10,warning=F}
plot_grid(
ggplot(data, aes(x= POR_htjan12)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() + 
  labs(x="Height - January 2012",y="") +
  annotate("text",x=400,y=300,label=paste0("Var = ",round(var(data$POR_htjan12,na.rm=T),2))),

ggplot(data, aes(x= POR_htmay12)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() + 
  labs(x="Height - May 2012",y="") +
  annotate("text",x=600,y=150,label=paste0("Var = ",round(var(data$POR_htmay12,na.rm=T),2))),

ggplot(data, aes(x= POR_htoct12)) + 
  geom_histogram(binwidth = 20,fill="seagreen3") +  
  theme_bw() +
  labs(x="Height - October 2012",y="") +
  annotate("text",x=900,y=100,label=paste0("Var = ",round(var(data$POR_htoct12,na.rm=T),2))),

ggplot(data, aes(x= POR_htmay13)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() +
  labs(x="Height - May 2013",y="") +
  annotate("text",x=1200,y=100,label=paste0("Var = ",round(var(data$POR_htmay13,na.rm=T),2))))
```

### Height values per provenances

```{r POR2012HeightGP, fig.height=10,fig.width=12,warning=F,message=F}
# Per provenance
# --------------

# Clones are colored according to the main gene pool (the gene pool for which the provenances have the highest proportion of belonging)

p <- ggplot(data, aes(x=POR_htoct12, fill=as.factor(max.Q))) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(prov)) + 
  scale_fill_manual(values=c("orangered3",    # Northern Africa
                              "gold2",        # Corsica
                              "darkorchid3",  # Central Spain
                              "navyblue",     # French Atlantic
                              "turquoise2",   # Iberian Atlantic
                              "green3"        # South-eastern Spain
                             ),
                    labels=c("Northern Africa", 
                             "Corsica",
                             "Central Spain",
                             "French Atlantic",
                             "Iberian Atlantic",
                             "South-eastern Spain")
                    ,name="Gene pools") +
  labs(x="",y="") +
  theme(legend.position = c(0.75, 0.07),
        legend.text = element_text(size=12),
        legend.title = element_text(size=14)) + 
  guides(fill=guide_legend(nrow=2))


p
ggsave(p,file="figs/ExploratoryAnalyses/HeightPortugal2012.png",height=10,width=12)
```

```{r POR2012HeightEMT, fig.height=10,fig.width=12,warning=F,message=F}
# Per provenance
# --------------

# Provenances are colored according to the value of EMT in their location

p <- ggplot(data, aes(x=POR_htoct12, fill=EMT)) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(prov), ncol = ncol.wrap) +
  labs(x="",y="") +
  scale_fill_gradient2(midpoint = mean(data$EMT,na.rm=T), 
                        low = "blue",  
                        mid = "yellow",
                        high = "red",
                        space = "Lab" ,
                       name="Extreme minimum temperature") +
  theme(legend.position = c(x.wrap,y.wrap),
        legend.text = element_text(size=10),
        legend.title = element_text(size=12))

p
ggsave(p,file="figs/ExploratoryAnalyses/HeightPortugal2012_EMTgradient.png",height=height.wrap,width=width.wrap)
```



```{r POR2012Heightbis, fig.height=10,fig.width=12,warning=F,message=F}
# Per block
# --------------

data %>% 
  drop_na(POR_htoct12) %>% 
  droplevels() %>% 
  ggplot(aes(x=POR_htoct12, fill=as.factor(block))) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(block)) + 
  labs(x="",y="") +
  theme(legend.position = "none")
```




# Phenology-related traits

## Bud burst

### All values

```{r BBnas}
data %>% dplyr::select(contains("s3")) %>% summary
```

There is less missing values in 2015.

```{r BBhist, fig.height=6,fig.width=6,warning=F}
plot_grid(
ggplot(data, aes(x= BDX_s32013)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() + 
  labs(x="Bud burst 2013",y="") +
  annotate("text",x=1000,y=900,label=paste0("Var = ",round(var(data$BDX_s32013,na.rm=T),2))),

ggplot(data, aes(x= BDX_s32014)) + 
  geom_histogram(binwidth = 20,fill="seagreen3") +  
  theme_bw() + 
  labs(x="Bud burst 2014",y="") +
  annotate("text",x=1700,y=750,label=paste0("Var = ",round(var(data$BDX_s32014,na.rm=T),2))),

ggplot(data, aes(x= BDX_s32015)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() +
  labs(x="Bud burst 2015",y="") +
  annotate("text",x=1500,y=1500,label=paste0("Var = ",round(var(data$BDX_s32015,na.rm=T),2))),

ggplot(data, aes(x= BDX_s32017)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() +
  labs(x="Bud burst 2017",y="") +
  annotate("text",x=1200,y=900,label=paste0("Var = ",round(var(data$BDX_s32017,na.rm=T),2))))
```


```{r BBhistMean,fig.height=4,fig.width=4}
meanBB <-data %>% 
  dplyr::select(prov,clon,tree,block,BDX_s32013,BDX_s32014,BDX_s32015,BDX_s32017) %>% 
  filter(rowSums(is.na(across(where(is.numeric)))) != ncol(.)-4) %>% 
  dplyr::mutate(mean = rowMeans(select(.,contains("BDX")),na.rm=T))

meanBB %>% 
  ggplot(aes(x= mean)) + 
  geom_histogram(binwidth = 15) +  
  theme_bw() + 
  labs(x="Mean bud burst over the 4 measurement years",y="")
```

### Per provenance 

```{r BDX2014BBGP, fig.height=10,fig.width=12,warning=F,message=F}
# Per provenance
# --------------

# Clones are colored according to the main gene pool (the gene pool for which the provenances have the highest proportion of belonging)

p <- ggplot(data, aes(x=BDX_s32014, fill=as.factor(max.Q))) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(prov)) + 
  scale_fill_manual(values=c("orangered3",    # Northern Africa
                              "gold2",        # Corsica
                              "darkorchid3",  # Central Spain
                              "navyblue",     # French Atlantic
                              "turquoise2",   # Iberian Atlantic
                              "green3"        # South-eastern Spain
                             ),
                    labels=c("Northern Africa", 
                             "Corsica",
                             "Central Spain",
                             "French Atlantic",
                             "Iberian Atlantic",
                             "South-eastern Spain")
                    ,name="Gene pools") +
  labs(x="",y="") +
  theme(legend.position = c(0.75, 0.07),
        legend.text = element_text(size=12),
        legend.title = element_text(size=14)) + 
  guides(fill=guide_legend(nrow=2))

p
ggsave(p,file="figs/ExploratoryAnalyses/BudBurstBordeaux2014.png",height=10,width=12)
```


```{r BDX2014BBEMT, fig.height=10,fig.width=12,warning=F,message=F}
# Per provenance
# --------------

# Provenances are colored according to the value of EMT in their location

p <- ggplot(data, aes(x=BDX_s32014, fill=EMT)) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(prov), ncol = ncol.wrap) +
  labs(x="",y="") +
  scale_fill_gradient2(midpoint = mean(data$EMT,na.rm=T), 
                        low = "blue",  
                        mid = "yellow",
                        high = "red",
                        space = "Lab" ,
                       name="Extreme minimum temperature") +
  theme(legend.position = c(x.wrap,y.wrap),
        legend.text = element_text(size=10),
        legend.title = element_text(size=12))

p
ggsave(p,file="figs/ExploratoryAnalyses/BudBurstBordeaux2014_EMTgradient.png",height=height.wrap,width=width.wrap)
```



## Duration of bud burst


### All values


```{r DBBnas}
data %>% dplyr::select(contains("dbb")) %>% summary
```

There is less missing values in 2015.

```{r DBBhist, fig.height=6,fig.width=6,warning=F}
plot_grid(
ggplot(data, aes(x= BDX_dbb2013)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() + 
  labs(x="Duration bud burst 2013",y="") +
  annotate("text",x=400,y=500,label=paste0("Var = ",round(var(data$BDX_dbb2013,na.rm=T),2))),

ggplot(data, aes(x= BDX_dbb2014)) + 
  geom_histogram(binwidth = 20,fill="seagreen3") +  
  theme_bw() + 
  labs(x="Duration bud burst 2014",y="") +
  annotate("text",x=750,y=800,label=paste0("Var = ",round(var(data$BDX_dbb2014,na.rm=T),2))),

ggplot(data, aes(x= BDX_dbb2015)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() +
  labs(x="Duration bud burst 2015",y="") +
  annotate("text",x=900,y=1000,label=paste0("Var = ",round(var(data$BDX_dbb2015,na.rm=T),2))),

ggplot(data, aes(x= BDX_dbb2017)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() +
  labs(x="Duration bud burst 2017",y="") +
  annotate("text",x=800,y=750,label=paste0("Var = ",round(var(data$BDX_dbb2017,na.rm=T),2))))
```


```{r DBBhistMean,fig.height=4,fig.width=4}
meanDBB <- data %>% 
  dplyr::select(prov,clon,tree,block,BDX_dbb2014,BDX_dbb2015,BDX_dbb2017) %>% 
  dplyr::filter(rowSums(is.na(across(where(is.numeric)))) != ncol(.)-4) %>% 
  dplyr::mutate(mean = rowMeans(select(.,contains("BDX")),na.rm=T))

meanDBB %>%   ggplot(aes(x= mean)) + 
  geom_histogram(binwidth = 15) +  
  theme_bw() + 
  labs(x="Mean duration of bud burst over the 3 measurement years",y="")
```

### Per provenance 


```{r BDX2014DBBGP, fig.height=10,fig.width=12,warning=F,message=F}
# Per provenance
# --------------

# Clones are colored according to the main gene pool (the gene pool for which the provenances have the highest proportion of belonging)

p <- ggplot(data, aes(x=BDX_dbb2014, fill=as.factor(max.Q))) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(prov)) + 
  scale_fill_manual(values=c("orangered3",    # Northern Africa
                              "gold2",        # Corsica
                              "darkorchid3",  # Central Spain
                              "navyblue",     # French Atlantic
                              "turquoise2",   # Iberian Atlantic
                              "green3"        # South-eastern Spain
                             ),
                    labels=c("Northern Africa", 
                             "Corsica",
                             "Central Spain",
                             "French Atlantic",
                             "Iberian Atlantic",
                             "South-eastern Spain")
                    ,name="Gene pools") +
  labs(x="",y="") +
  theme(legend.position = c(0.75, 0.07),
        legend.text = element_text(size=12),
        legend.title = element_text(size=14)) + 
  guides(fill=guide_legend(nrow=2))


p
ggsave(p,file="figs/ExploratoryAnalyses/DurationBudBurstBordeaux2014.png",height=10,width=12)
```


```{r BDX2014DBBEMT, fig.height=10,fig.width=12,warning=F,message=F}
# Per provenance
# --------------

# Provenances are colored according to the value of EMT in their location


p <- ggplot(data, aes(x=BDX_dbb2014, fill=EMT)) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(prov), ncol = ncol.wrap) +
  labs(x="",y="") +
  scale_fill_gradient2(midpoint = mean(data$EMT,na.rm=T), 
                        low = "blue",  
                        mid = "yellow",
                        high = "red",
                        space = "Lab" ,
                       name="Extreme minimum temperature") +
  theme(legend.position = c(x.wrap,y.wrap),
        legend.text = element_text(size=10),
        legend.title = element_text(size=12))

p
ggsave(p,file="figs/ExploratoryAnalyses/DurationBudBurstBordeaux2014_EMTgradient.png",
       height=height.wrap,width=width.wrap)
```



```{r}
table(data$BDX_s12013,data$BDX_s42013) # In 2013, only 32 trees were both measured at stage s1 and s4.
table(data$BDX_s12014,data$BDX_s42014)
table(data$BDX_s12015,data$BDX_s42015)
table(data$BDX_s12017,data$BDX_s42017)
```

**In the following analyses, we are going to select the mean bud burst date over the four years and the mean duration of bud burst over three years, as it will be easier from a statistical point of view (the trait distribution is almost normal), and it buffers the variations among years.**

# Functional traits

## $\delta^{13}C$

```{r d13C}
data %>% dplyr::select(contains("d13C")) %>% summary
```

### All values

```{r d13Chist, fig.height=4,fig.width=4,warning=F}
ggplot(data, aes(x= d13C)) + 
  geom_histogram(binwidth = 0.1,fill="seagreen3") +  
  theme_bw() + 
  labs(x="Delta 13 C",y="") +
  annotate("text",x=-30,y=60,label=paste0("Var = ",round(var(data$d13C,na.rm=T),2)))
```

### Per provenance

```{r PORd13CGP, fig.height=10,fig.width=12,warning=F,message=F}
# Per provenance
# --------------

# Clones are colored according to the main gene pool (the gene pool for which the provenances have the highest proportion of belonging)

p <- ggplot(data, aes(x=d13C, fill=as.factor(max.Q))) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(prov)) + 
  scale_fill_manual(values=c("orangered3",      # Northern Africa
                              "gold2",          # Corsica
                              "darkorchid3",    # Central Spain
                              "navyblue",       # French Atlantic
                              "turquoise2",     # Iberian Atlantic
                              "green3"          # South-eastern Spain
                             ),
                    labels=c("Northern Africa", 
                             "Corsica",
                             "Central Spain",
                             "French Atlantic",
                             "Iberian Atlantic",
                             "South-eastern Spain")
                    ,name="Gene pools") +
  labs(x="",y="") +
  theme(legend.position = c(0.75, 0.07),
        legend.text = element_text(size=12),
        legend.title = element_text(size=14)) + 
  guides(fill=guide_legend(nrow=2))

p
ggsave(p,file="figs/ExploratoryAnalyses/d13C.png",height=10,width=12)
```


```{r PORd13CEMT, fig.height=10,fig.width=12,warning=F,message=F}
# Per provenance
# --------------

# Provenances are colored according to the value of EMT in their location

p <- ggplot(data, aes(x=d13C, fill=EMT)) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(prov), ncol = ncol.wrap) +
  labs(x="",y="") +
  scale_fill_gradient2(midpoint = mean(data$EMT,na.rm=T), 
                        low = "blue",  
                        mid = "yellow",
                        high = "red",
                        space = "Lab" ,
                       name="Extreme minimum temperature") +
  theme(legend.position = c(x.wrap,y.wrap),
        legend.text = element_text(size=10),
        legend.title = element_text(size=12))

p
ggsave(p,file="figs/ExploratoryAnalyses/d13C_EMTgradient.png",height=height.wrap,width=width.wrap)
```

## Specific leaf area

```{r SLA}
data %>% dplyr::select(contains("SLA")) %>% summary
```

### All values

```{r SLAhist, fig.height=4,fig.width=8,warning=F}
plot_grid(ggplot(data, aes(x= POR_SLA)) + 
  geom_histogram(binwidth = 0.1,fill="seagreen3") +  
  theme_bw() + 
  labs(x="Specific Leaf Area",y="") +
  annotate("text",x=9,y=130,label=paste0("Var = ",round(var(data$POR_SLA,na.rm=T),2))),

ggplot(data, aes(x= log(POR_SLA))) + 
  geom_histogram(binwidth = 0.01,fill="seagreen3") +  
  theme_bw() + 
  labs(x="Specific Leaf Area",y="") +
  annotate("text",x=2.05,y=50,label=paste0("Var = ",round(var(log(data$POR_SLA),na.rm=T),2))),
nrow=1)
```

### Per provenance

```{r PORSLAGP, fig.height=10,fig.width=12,warning=F,message=F}
# Per provenance
# --------------

# Clones are colored according to the main gene pool (the gene pool for which the provenances have the highest proportion of belonging)

p <- ggplot(data, aes(x=POR_SLA, fill=as.factor(max.Q))) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(prov)) + 
  scale_fill_manual(values=c("orangered3",    # Northern Africa
                              "gold2",        # Corsica
                              "darkorchid3",  # Central Spain
                              "navyblue",     # French Atlantic
                              "turquoise2",   # Iberian Atlantic
                              "green3"        # South-eastern Spain
                             ),
                    labels=c("Northern Africa", 
                             "Corsica",
                             "Central Spain",
                             "French Atlantic",
                             "Iberian Atlantic",
                             "South-eastern Spain")
                    ,name="Gene pools") +
  labs(x="",y="") +
  theme(legend.position = c(0.75, 0.07),
        legend.text = element_text(size=12),
        legend.title = element_text(size=14)) + 
  guides(fill=guide_legend(nrow=2))

p
ggsave(p,file="figs/ExploratoryAnalyses/PORSLA.png",height=10,width=12)
```

```{r PORSLAEMT, fig.height=10,fig.width=12,warning=F,message=F}
# Per provenance
# --------------

# Provenances are colored according to the value of EMT in their location


p <- ggplot(data, aes(x=POR_SLA, fill=EMT)) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(prov), ncol = ncol.wrap) +
  labs(x="",y="") +
  scale_fill_gradient2(midpoint = mean(data$EMT,na.rm=T), 
                        low = "blue",  
                        mid = "yellow",
                        high = "red",
                        space = "Lab" ,
                       name="Extreme minimum temperature") +
  theme(legend.position = c(x.wrap,y.wrap),
        legend.text = element_text(size=10),
        legend.title = element_text(size=12))

p
ggsave(p,file="figs/ExploratoryAnalyses/PORSLA_EMTgradient.png",height=height.wrap,width=width.wrap)
```

# Summary - All selected traits

## Figure S1

```{r DistributionAllSelectedTraits,fig.height=14,fig.width=10,warning=F,message=F}
fontsize=8
ymean = 0.82
yvar = 0.92

p <- plot_grid(
  # Height Portugal (Fundão) 2012
ggplot(data, aes(x= POR_htoct12)) + 
  geom_histogram(binwidth = 20,fill="#B2182B",alpha=0.7) +  
  theme_bw() +
  labs(x="Height (Portugal, 20 months, mm)",y="") +
  annotation_custom(grobTree(textGrob(paste0("Variance : ",
                                             round(var(data$POR_htoct12,na.rm=T),2)), 
                                      x=0.7,  
                                      y=yvar, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))) +
  annotation_custom(grobTree(textGrob(paste0("Mean : ",
                                             round(mean(data$POR_htoct12,na.rm=T),2)), 
                                      x=0.7,  
                                      y=ymean, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))),

  # Height Bordeaux 2013
ggplot(data, aes(x= BDX_htnov13)) + 
  geom_histogram(binwidth = 20, fill="#D73027",alpha=0.7) +  
  theme_bw() + 
  labs(x="Height (Bordeaux, 25 months, mm)",y="") +
  annotation_custom(grobTree(textGrob(paste0("Variance : ",
                                             round(var(data$BDX_htnov13,na.rm=T),2)), 
                                      x=0.7,  
                                      y=yvar, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))) +
  annotation_custom(grobTree(textGrob(paste0("Mean : ",
                                             round(mean(data$BDX_htnov13,na.rm=T),2)), 
                                      x=0.7,  
                                      y=ymean, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))),

  # Height Bordeaux 2018
ggplot(data, aes(x= BDX_htnov18)) + 
  geom_histogram(binwidth = 20, fill="#F46D43",alpha=0.7) +  
  theme_bw() + 
  labs(x="Height (Bordeaux, 85 months, mm)",y="") +
  annotation_custom(grobTree(textGrob(paste0("Variance : ",
                                             round(var(data$BDX_htnov18,na.rm=T),2)), 
                                      x=0.7,  
                                      y=yvar, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))) +
  annotation_custom(grobTree(textGrob(paste0("Mean : ",
                                             round(mean(data$BDX_htnov18,na.rm=T),2)), 
                                      x=0.7,  
                                      y=ymean, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))),
  
  # Height Cabada (Asturias) 2012
ggplot(data, aes(x= AST_htnov12)) + 
  geom_histogram(binwidth = 20, fill="#FDAE61",alpha=0.7) +  
  theme_bw() + 
  labs(x="Height (Asturias, 21 months, mm)",y="") +
  annotation_custom(grobTree(textGrob(paste0("Variance : ",
                                             round(var(data$AST_htnov12,na.rm=T),2)), 
                                      x=0.7,  
                                      y=yvar, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))) +
  annotation_custom(grobTree(textGrob(paste0("Mean : ",
                                             round(mean(data$AST_htnov12,na.rm=T),2)), 
                                      x=0.7,  
                                      y=ymean, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))),

  # Mean bud burst date Bordeaux
ggplot(meanBB,aes(x= mean)) + 
  geom_histogram(binwidth = 10,fill="#5AAE61",alpha=0.7) +  
  theme_bw() + 
  labs(x="Mean bud burst date (Bordeaux, over four years, °C-day)",y="") +
  annotation_custom(grobTree(textGrob(paste0("Variance : ",
                                             round(var(meanBB$mean,na.rm=T),2)), 
                                      x=0.7,  
                                      y=yvar, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))) +
  annotation_custom(grobTree(textGrob(paste0("Mean : ",
                                             round(mean(meanBB$mean,na.rm=T),2)), 
                                      x=0.7,  
                                      y=ymean, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))),

  # Mean duration bud burst Bordeaux
ggplot(meanDBB,aes(x= mean)) + 
  geom_histogram(binwidth = 10,fill="#A6DBA0",alpha=0.7) +  
  theme_bw() + 
  labs(x="Mean duration of bud burst (Bordeaux, over three years, °C-day)",y="") +
  annotation_custom(grobTree(textGrob(paste0("Variance : ",
                                             round(var(meanDBB$mean,na.rm=T),2)), 
                                      x=0.7,  
                                      y=yvar, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))) +
  annotation_custom(grobTree(textGrob(paste0("Mean : ",
                                             round(mean(meanDBB$mean,na.rm=T),2)), 
                                      x=0.7,  
                                      y=ymean, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))),

  # SLA Portugal 
ggplot(data, aes(x= log(POR_SLA))) + 
  geom_histogram(binwidth = 0.01,fill="#4575B4",alpha=0.7) +  
  theme_bw() + 
  labs(x=TeX("Log(Specific Leaf Area) (Portugal, m$^{2}$/kg)"),y="") +
  annotation_custom(grobTree(textGrob(paste0("Variance : ",
                                             round(var(log(data$POR_SLA),na.rm=T),2)), 
                                      x=0.7,  
                                      y=yvar, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))) +
  annotation_custom(grobTree(textGrob(paste0("Mean : ",
                                             round(mean(log(data$POR_SLA),na.rm=T),2)), 
                                      x=0.7,  
                                      y=ymean, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))),
  # delta13C Portugal
ggplot(data, aes(x= d13C)) + 
  geom_histogram(binwidth = 0.1,fill="#ABD9E9",alpha=0.7) +  
  theme_bw() + 
  labs(x=TeX("$\\delta^{13}C$ (Portugal, ‰)"),y="")+
  annotation_custom(grobTree(textGrob(paste0("Variance : ",
                                             round(var(data$d13C,na.rm=T),2)), 
                                      x=0.7,  
                                      y=yvar, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))) +
  annotation_custom(grobTree(textGrob(paste0("Mean : ",
                                             round(mean(data$d13C,na.rm=T),2)), 
                                      x=0.7,  
                                      y=ymean, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))),

nrow=4)

p

ggsave(p,file=paste0("figs/ExploratoryAnalyses/TraitsDistribution.png"),width = 10,height=8)
```

## Table S1 & S2

```{r TableSuppInfoPhenoData}
# the numbers in the columns "Trees", "Populations" and "Clones" were checked with the model inputs (May 12th)
tibble(Traits=c(rep("Height",4),"Mean bud burst date", "Mean duration of bud burst","Surface Leaf Area","$\\delta^{13}$C"),
       
       "Common gardens"=c("Portugal",rep("Bordeaux",2),"Cabada",rep("Bordeaux",2),rep("Portugal",2)),
       
       "Dates of measurement" =c("October 2012","November 2013", "November 2018","November 2012", "2013, 2014, 2015, 2017", "2014, 2015 2017", NA,NA),
       
       "Tree age"=c(20,25,85,21,"-","-",NA,NA),
       
       "Survival"=c(
      # Proportion survival Portugal 
      round(table(data$POR_survoct12)[[2]]/(table(data$POR_survoct12)[[1]]+table(data$POR_survoct12)[[2]]),2),
      
       # Proportion survival Bordeaux 2013
       round(table(data$BDX_surv13)[[2]]/(table(data$BDX_surv13)[[1]]+table(data$BDX_surv13)[[2]]),2),
       
       # Proportion survival Bordeaux 2018
       round(table(data$BDX_surv18)[[2]]/(table(data$BDX_surv18)[[1]]+table(data$BDX_surv18)[[2]]),2),
      
      # Proportion survival Asturias
      round(table(data$AST_survnov12)[[2]]/(table(data$AST_survnov12)[[1]]+table(data$AST_survnov12)[[2]]),2),
 
       "-","-","-","-"),
      
       "Units"=c(rep("mm",4),"°C-day","°C-day","m$^{2}$/kg","‰"),
       
       "Trees"=c(length(data$tree[!is.na(data$POR_htoct12)]),  # height Portugal 2012
                 length(data$tree[!is.na(data$BDX_htnov13)]),  # height Bordeaux 2013
                 length(data$tree[!is.na(data$BDX_htnov18)]),  # height Bordeaux 2018
                 length(data$tree[!is.na(data$AST_htnov12)]),  # height Cabada (Asturias) 2012
                 length(meanBB$tree[!is.na(meanBB$mean)]),     # mean bud burst date Bordeaux
                 length(meanDBB$tree[!is.na(meanDBB$mean)]),   # mean duration bud burst Bordeaux
                 length(data$tree[!is.na(data$POR_SLA)]),      # SLA Portugal 
                 length(data$tree[!is.na(data$d13C)])),        # delta 13 C Portugal 
       
        "Populations" = c(length(unique(data$prov[!is.na(data$POR_htoct12)])), # height Portugal 2012
                          length(unique(data$prov[!is.na(data$BDX_htnov13)])), # height Bordeaux 2013
                          length(unique(data$prov[!is.na(data$BDX_htnov18)])), # height Bordeaux 2018
                          length(unique(data$prov[!is.na(data$AST_htnov12)])), # height Asturias 2012
                          length(unique(meanBB$prov[!is.na(meanBB$mean)])),    # mean bud burst date Bordeaux
                          length(unique(meanDBB$prov[!is.na(meanDBB$mean)])),  # mean duration bud burst Bordeaux
                          length(unique(data$prov[!is.na(data$POR_SLA)])),     # SLA Portugal 
                          length(unique(data$prov[!is.na(data$d13C)]))),       # delta 13 C Portugal 
                          
        "Clones" = c(length(unique(data$clon[!is.na(data$POR_htoct12)])), # height Portugal 2012
                     length(unique(data$clon[!is.na(data$BDX_htnov13)])), # height Bordeaux 2013
                     length(unique(data$clon[!is.na(data$BDX_htnov18)])), # height Bordeaux 2018
                     length(unique(data$clon[!is.na(data$AST_htnov12)])), # height Asturias 2012
                     length(unique(meanBB$clon[!is.na(meanBB$mean)])),    # mean bud burst date Bordeaux
                     length(unique(meanDBB$clon[!is.na(meanDBB$mean)])),  # mean duration bud burst Bordeaux
                     length(unique(data$clon[!is.na(data$POR_SLA)])),     # SLA Portugal 
                     length(unique(data$clon[!is.na(data$d13C)]))),       # delta 13 C Portugal   
       
        "Blocks" = c(length(unique(data$block[!is.na(data$POR_htoct12)])), # height Portugal 2012
                     length(unique(data$block[!is.na(data$BDX_htnov13)])), # height Bordeaux 2013
                     length(unique(data$block[!is.na(data$BDX_htnov18)])), # height Bordeaux 2018
                     length(unique(data$block[!is.na(data$AST_htnov12)])), # height Asturias 2012
                     length(unique(meanBB$block[!is.na(meanBB$mean)])),    # mean bud burst date Bordeaux
                     length(unique(meanDBB$block[!is.na(meanDBB$mean)])),  # mean duration bud burst Bordeaux
                     length(unique(data$block[!is.na(data$POR_SLA)])),     # SLA Portugal 
                     length(unique(data$block[!is.na(data$d13C)])))        # delta 13 C Portugal   
          ) %>% 
  
  kable(caption="Table S1 of the paper",escape = FALSE) %>%
  kable_styling(font_size=11,
                bootstrap_options = c("striped","hover", "condensed"), full_width = F)
```

## Failed visualisations

Here initially, I wanted to visualise the population-specific total genetic variances against the potential drivers of genetic variation. However, such visualisation is not possible with the raw data as we do not have access directly to the population-specific total genetic variances (which have to be estimated with quantitative genetic models like the one used in our study). That's why the following plots make no sense (I guess to remove later)...

```{r PopSpecificVarMeans}
tab <- c("MeanBB","MeanDBB") %>% 
  mclapply(function(x) {
  if(x=="MeanBB") data <- meanBB else if(x=="MeanDBB") 
    data <- meanDBB
    data %>% 
      dplyr::select(prov,mean) %>% 
      drop_na() %>% 
      dplyr::rename(value=mean) %>% 
      group_by(prov) %>%  
      dplyr::summarise_at("value",list(mean=mean,variance=var)) %>% 
      dplyr::mutate(trait=x)}) %>% 
  bind_rows() %>% 
  pivot_wider(names_from=trait,values_from=c(mean,variance))

tab <- c("POR_htoct12","BDX_htnov13","BDX_htnov18","AST_htnov12","POR_SLA","d13C") %>% 
  mclapply(function(x) 
    data %>% 
      dplyr::select(prov,x) %>% 
      drop_na() %>% 
      group_by(prov) %>% 
      dplyr::summarise_at(all_of(x),list(mean=mean,variance=var)) %>% 
      mutate(trait=x)) %>% 
  bind_rows() %>% 
  pivot_wider(names_from=trait,values_from=c(mean,variance)) %>% 
  inner_join(tab,by="prov") %>% 
  dplyr::select(prov,contains("mean_"),contains("var"))



tab %>% 
  kable(digits=2,caption="Table S2 of the paper",escape = FALSE) %>%
  kable_styling(font_size=10,
                bootstrap_options = c("striped","hover", "condensed"), full_width = F) %>%
  column_spec(1, bold = T)
```


```{r ScatterPlotsSdPopAgainstDrivers}
#  !!  this script does not take into account the variable transformations! (centering, and log) !! 
# That's why it is not used for data visualization in the Supp Info.

drivers <- c("A","D","EH1[20km]","EH2[20km]","EH1[1.6km]","EH2[1.6km]","SHM","invEMT")
traits <- c("POR_htoct12","BDX_htnov13","BDX_htnov18","AST_htnov12","MeanBB","MeanDBB","POR_SLA","d13C")

tab <- c("MeanBB","MeanDBB") %>% 
  mclapply(function(x) {
  if(x=="MeanBB") data <- meanBB else if(x=="MeanDBB") 
    data <- meanDBB
    data %>% 
      dplyr::select(prov,mean) %>% 
      drop_na() %>% 
      dplyr::rename(value=mean) %>% 
      group_by(prov) %>%  
      dplyr::summarise_at("value",list(sd=sd)) %>% 
      dplyr::mutate(trait=x)}) %>% 
  bind_rows()

tab <- c("POR_htoct12","BDX_htnov13","BDX_htnov18","AST_htnov12","POR_SLA","d13C") %>% 
  mclapply(function(x) 
    data %>% 
      dplyr::select(prov,x) %>% 
      drop_na() %>% 
      group_by(prov) %>% 
      dplyr::summarise_at(all_of(x),list(sd=sd)) %>% 
      mutate(trait=x)) %>% 
  bind_rows() %>% 
  bind_rows(tab)


tab <- readRDS(file="data/DF_Drivers.rds") %>% 
  dplyr::select(prov,A,D,EH.20km.PC1,EH.20km.PC2,EH.1km.PC1,EH.1km.PC2,SHM,invEMT) %>% 
  dplyr::mutate(across(-prov, ~ scale(.)[,1])) %>%
  set_names(c("prov",drivers)) %>% 
  pivot_longer(cols=all_of(drivers),names_to = "driver.name",values_to="driver.value") %>% 
  inner_join(tab,by="prov")
  
mclapply(traits,function(x){ 

scatterplots <- mclapply(drivers, function(driver){

  tab %>% 
    dplyr::filter(trait==x,driver.name==driver) %>% 
    ggplot(aes(x=driver.value, y=log(sd))) + 
    geom_point()+
    xlab(driver) + 
    ylab("log(sd(trait))") +
    #ylim(list.ylim[[x]]) +
    panel_border() # a border around each panel
  
})

names(scatterplots) <- drivers

scatterplots[[2]] <- scatterplots[[2]] + ylab("")
scatterplots[[3]] <- scatterplots[[3]] + ylab("")
scatterplots[[4]] <- scatterplots[[4]] + ylab("")
scatterplots[[6]] <- scatterplots[[6]] + ylab("")
scatterplots[[7]] <- scatterplots[[7]] + ylab("")
scatterplots[[8]] <- scatterplots[[8]] + ylab("")

p <- plot_grid(plotlist=scatterplots, nrow=2)

ggsave(p,file=paste0("figs/ExploratoryAnalyses/",x,"_ScatterPlots_LogSdTrait_Drivers.png"),height=10,width=18)
  
  })
```


```{r ScatterPlotsVarPopAgainstDrivers}
# This script does take into account the data transformations (i.e.  mean-centering and log transformation)
traits <- c("POR_htoct12","BDX_htnov13","BDX_htnov18","AST_htnov12","MeanBB","MeanDBB","POR_SLA","d13C")

tab.traits <- mclapply(traits,function(trait){ 
  
# Trait transformations
if(trait=="MeanBB"|trait=="MeanDBB"|trait=="d13C"){
    CenterResponseVariable <- TRUE
    LogResponseVariable <- FALSE
    
    # SLA is not centered and we used its logarithm as response variable
  }  else if(trait=="POR_SLA"){ 
    CenterResponseVariable <- FALSE
    LogResponseVariable <- TRUE
    
    # Height is not transformed
  } else { 
    CenterResponseVariable <- FALSE
    LogResponseVariable <- FALSE
  }

  
# Extracting the population-specific standard deviations for each trait
  if(trait=="MeanBB"|trait=="MeanDBB"){
      
  df <- readRDS(file="data/ClonapinData/PhenoDataNovember2019_AnnualTraits.rds") %>% 
    dplyr::filter(!(prov=="MAD")) %>% 
    when(trait=="MeanBB" ~ dplyr::select(.,prov,clon,tree,block,BDX_s32013,BDX_s32014,BDX_s32015,BDX_s32017),
         ~ dplyr::select(.,prov,clon,tree,block,BDX_dbb2014,BDX_dbb2015,BDX_dbb2017)) %>% 
    filter(rowSums(is.na(across(where(is.numeric)))) != ncol(.)-4) %>% 
    dplyr::mutate(trait.value = rowMeans(select(.,contains("BDX")),na.rm=T)) %>%
    execute_if(CenterResponseVariable, mutate(trait.value=trait.value-mean(trait.value))) %>% 
    execute_if(LogResponseVariable, mutate(trait.value=log(trait.value))) %>% 
    group_by(clon) %>% 
    dplyr::summarise(trait.mean=mean(trait.value)) %>% 
    mutate(prov=str_sub(clon,1,3)) %>% 
    group_by(prov) %>% 
    dplyr::summarise(trait.variance=var(trait.mean)) %>% 
    mutate(trait=trait)
  
  } else {
    
  df <- readRDS(file="data/ClonapinData/PhenoDataNovember2019_AnnualTraits.rds") %>% 
    dplyr::filter(!(prov=="MAD")) %>% 
    dplyr::rename(trait.value=all_of(trait)) %>% 
    dplyr::select(prov,clon,trait.value) %>% 
    drop_na() %>%  
    execute_if(CenterResponseVariable, mutate(trait.value=trait.value-mean(trait.value))) %>% 
    execute_if(LogResponseVariable, mutate(trait.value=log(trait.value))) %>% 
    group_by(clon) %>% 
    dplyr::summarise(trait.mean=mean(trait.value)) %>% 
    mutate(prov=str_sub(clon,1,3)) %>% 
    group_by(prov) %>% 
    dplyr::summarise(trait.variance=var(trait.mean)) %>% 
    mutate(trait=trait)
  
  }
}) %>% bind_rows()


tab <- readRDS(file="data/DF_Drivers.rds") %>% 
  dplyr::select(prov,A,D,EH.20km.PC1,EH.20km.PC2,EH.1km.PC1,EH.1km.PC2,SHM,invEMT) %>% 
  dplyr::mutate(across(-prov, ~ scale(.)[,1])) %>%
  set_names(c("prov",drivers)) %>% 
  pivot_longer(cols=all_of(drivers),names_to = "driver.name",values_to="driver.value") %>% 
  inner_join(tab.traits,by="prov")
  
mclapply(traits,function(x){ 

scatterplots <- mclapply(drivers, function(driver){

  tab %>% 
    dplyr::filter(trait==x,driver.name==driver) %>% 
    ggplot(aes(x=driver.value, y=trait.variance)) + 
    geom_point()+
    xlab(driver) + 
    ylab("Var(trait)") +
    #ylim(list.ylim[[x]]) +
    panel_border() # a border around each panel
  
})

names(scatterplots) <- drivers

scatterplots[[2]] <- scatterplots[[2]] + ylab("")
scatterplots[[3]] <- scatterplots[[3]] + ylab("")
scatterplots[[4]] <- scatterplots[[4]] + ylab("")
scatterplots[[6]] <- scatterplots[[6]] + ylab("")
scatterplots[[7]] <- scatterplots[[7]] + ylab("")
scatterplots[[8]] <- scatterplots[[8]] + ylab("")

p <- plot_grid(plotlist=scatterplots, nrow=2)

ggsave(p,file=paste0("figs/ExploratoryAnalyses/",x,"_ScatterPlots_TraitVariance_Drivers.png"),height=10,width=18)
  
  })
```

