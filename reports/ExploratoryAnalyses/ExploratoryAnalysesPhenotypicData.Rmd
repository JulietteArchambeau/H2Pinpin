---
title: "Phenotypic traits"
author: "Juliette Archambeau"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    # code_fold: hide
    toc: true
    toc_depth: 4
    toc_float:
       collapsed: false
    number_sections: true
    highlight: textmate
editor_options: 
  chunk_output_type: console
---

<style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;
  white-space: pre;
}
</style>

<style type="text/css">
div.main-container {
  max-width: 2000px;
  margin-left: auto;
  margin-right: auto;
}
</style>


```{css, echo=FALSE}
pre {
  max-height: 300px;
  overflow-y: auto;
}

pre[class] {
  max-height: 600px;
}
```


```{r setup, include=FALSE}
# knitr::opts_chunk$set(fig.width = 5,fig.height = 4,cache=TRUE,cache.lazy = FALSE)
knitr::opts_chunk$set(fig.width = 5,fig.height = 4,cache=FALSE)
options(width = 300)
options(knitr.table.format = "latex")
library(knitr)      # CRAN v1.26
library(dplyr)      # CRAN v1.0.0
library(tidyverse)  # CRAN v1.3.0
library(latex2exp)  # CRAN v0.4.0
library(cowplot)    # CRAN v1.0.0
library(kableExtra) # CRAN v1.1.0
library(grid)
```


Sum-up of the traits selected in this study:

  - Height:
      
      - In Fundão (Portugal): height in October 2012 when the trees were 20 month old.
      
      - In Cabada (Asturias, Spain): height in November 2012 when the trees were 21 month old.
      
      - In Pierroton (France):  height in November 2013 when the trees were 25 month old & in November 2018 when the trees were 85 month old.
    
  - Phenology:
      
      - bud burst (=date of brachybalst emergence) in 2014 in Pierroton
      
      - duration of bud burst in 2014 in Pierroton.
      
  - Functional traits
  
     - $\delta^{13}C$
     
     - Surface Leaf Area (SLA)


In the document, the plots colored in green correspond to the trait selected in the study.

```{r}
data <- readRDS(file="data/ClonapinData/PhenoDataNovember2019_AnnualTraits.rds") %>% 
   dplyr::filter(!(prov=="MAD"))
```


# Height


```{r HeightNAs}
data %>% dplyr::select(contains("ht")) %>% summary
```

## Pierroton (France) - November 2013 and 2018


```{r BBhistBordeaux, fig.height=10,fig.width=10,warning=F}
plot_grid(
ggplot(data, aes(x= BDX_htnov13)) + 
  geom_histogram(binwidth = 20, fill="seagreen3") +  
  theme_bw() + 
  labs(x="Height 2013",y="") +
  annotate("text",x=1500,y=150,label=paste0("Var = ",round(var(data$BDX_htnov13,na.rm=T),2))),

ggplot(data, aes(x= BDX_htnov14)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() + 
  labs(x="Height 2014",y="") +
  annotate("text",x=2300,y=80,label=paste0("Var = ",round(var(data$BDX_htnov14,na.rm=T),2))),

ggplot(data, aes(x= BDX_htnov15)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() +
  labs(x="Height 2015",y="") +
  annotate("text",x=3000,y=60,label=paste0("Var = ",round(var(data$BDX_htnov15,na.rm=T),2))),

ggplot(data, aes(x= BDX_htnov18)) + 
  geom_histogram(binwidth = 20, fill="seagreen3") +  
  theme_bw() + 
  labs(x="Height 2018",y="") +
  annotate("text",x=6500,y=50,label=paste0("Var = ",round(var(data$BDX_htnov18,na.rm=T),2))))
```


```{r BDX2013Height, fig.height=10,fig.width=12,warning=F,message=F}
p <- ggplot(data, aes(x=BDX_htnov13, fill=as.factor(prov))) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(prov)) + 
  scale_fill_manual(values=c("turquoise2",
                              "turquoise2",
                              "darkorchid3",
                              "darkorchid3",
                              "darkorchid3",
                              "turquoise2",
                              
                              "darkorchid3",
                              "turquoise2",
                              "darkorchid3",
                              "darkorchid3",
                              "green3",
                              "darkorchid3",
                              
                              "navyblue",
                              "turquoise2",
                              "darkorchid3",
                              # "orangered3", # no MAD in Bordeaux
                              "navyblue",
                              "darkorchid3",
                              
                              "navyblue",
                              "green3",
                              "navyblue",
                              "gold2",
                              "gold2",
                              "navyblue",
                              
                              "turquoise2",
                              "darkorchid3",
                              "turquoise2",
                              "darkorchid3",
                              "turquoise2",
                              "turquoise2",
                              
                              "navyblue",
                              "orangered3",
                              "darkorchid3",
                              "navyblue")) +
  labs(x="",y="") +
  theme(legend.position = "none")

p
ggsave(p,file="figs/ExploratoryAnalyses/HeightPierroton2013.png",height=10,width=12)
```

```{r BDX2018Height, fig.height=10,fig.width=12,warning=F,message=F}
p <- ggplot(data, aes(x=BDX_htnov18, fill=as.factor(prov))) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(prov)) + 
  scale_fill_manual(values=c("turquoise2",
                              "turquoise2",
                              "darkorchid3",
                              "darkorchid3",
                              "darkorchid3",
                              "turquoise2",
                              
                              "darkorchid3",
                              "turquoise2",
                              "darkorchid3",
                              "darkorchid3",
                              "green3",
                              "darkorchid3",
                              
                              "navyblue",
                              "turquoise2",
                              "darkorchid3",
                              # "orangered3", # no MAD in Bordeaux
                              "navyblue",
                              "darkorchid3",
                              
                              "navyblue",
                              "green3",
                              "navyblue",
                              "gold2",
                              "gold2",
                              "navyblue",
                              
                              "turquoise2",
                              "darkorchid3",
                              "turquoise2",
                              "darkorchid3",
                              "turquoise2",
                              "turquoise2",
                              
                              "navyblue",
                              "orangered3",
                              "darkorchid3",
                              "navyblue")) +
  labs(x="",y="") +
  theme(legend.position = "none")
p
ggsave(p,file="figs/ExploratoryAnalyses/HeightPierroton2018.png",height=10,width=12)
```


## Cabada (Asturias, Spain) - November 2012


```{r BBhistCabada, fig.height=10,fig.width=10,warning=F}
plot_grid(
ggplot(data, aes(x= AST_htdec11)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() + 
  labs(x="Height - December 2011",y="") +
  annotate("text",x=580,y=300,label=paste0("Var = ",round(var(data$BDX_htnov13,na.rm=T),2))),

ggplot(data, aes(x= AST_htnov12)) + 
  geom_histogram(binwidth = 20, fill="seagreen3") +  
  theme_bw() + 
  labs(x="Height - November 2012",y="") +
  annotate("text",x=1200,y=150,label=paste0("Var = ",round(var(data$BDX_htnov14,na.rm=T),2))),

ggplot(data, aes(x= AST_htmar14)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() +
  labs(x="Height - March 2014",y="") +
  annotate("text",x=2100,y=100,label=paste0("Var = ",round(var(data$BDX_htnov15,na.rm=T),2))))
```


```{r AST2012Height, fig.height=10,fig.width=12,warning=F,message=F}
p <- ggplot(data, aes(x=AST_htnov12, fill=as.factor(prov))) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(prov)) + 
  scale_fill_manual(values=c("turquoise2",
                              "turquoise2",
                              "darkorchid3",
                              "darkorchid3",
                              "darkorchid3",
                              "turquoise2",
                              
                              "darkorchid3",
                              "turquoise2",
                              "darkorchid3",
                              "darkorchid3",
                              "green3",
                              "darkorchid3",
                              
                              "navyblue",
                              "turquoise2",
                              "darkorchid3",
                              "orangered3", # no MAD in Bordeaux
                              "navyblue",
                              "darkorchid3",
                              
                              "navyblue",
                              "green3",
                              "navyblue",
                              "gold2",
                              "gold2",
                              "navyblue",
                              
                              "turquoise2",
                              "darkorchid3",
                              "turquoise2",
                              "darkorchid3",
                              "turquoise2",
                              "turquoise2",
                              
                              "navyblue",
                              "orangered3",
                              "darkorchid3",
                              "navyblue")) +
  labs(x="",y="") +
  theme(legend.position = "none")

p
ggsave(p,file="figs/ExploratoryAnalyses/HeightAsturias2012.png",height=10,width=12)
```



## Fundão (Portugal) - October 2012

```{r BBhistFundao, fig.height=10,fig.width=10,warning=F}
plot_grid(
ggplot(data, aes(x= POR_htjan12)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() + 
  labs(x="Height - January 2012",y="") +
  annotate("text",x=400,y=300,label=paste0("Var = ",round(var(data$POR_htjan12,na.rm=T),2))),

ggplot(data, aes(x= POR_htmay12)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() + 
  labs(x="Height - May 2012",y="") +
  annotate("text",x=600,y=150,label=paste0("Var = ",round(var(data$POR_htmay12,na.rm=T),2))),

ggplot(data, aes(x= POR_htoct12)) + 
  geom_histogram(binwidth = 20,fill="seagreen3") +  
  theme_bw() +
  labs(x="Height - October 2012",y="") +
  annotate("text",x=900,y=100,label=paste0("Var = ",round(var(data$POR_htoct12,na.rm=T),2))),

ggplot(data, aes(x= POR_htmay13)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() +
  labs(x="Height - May 2013",y="") +
  annotate("text",x=1200,y=100,label=paste0("Var = ",round(var(data$POR_htmay13,na.rm=T),2))))
```


```{r POR2012Height, fig.height=10,fig.width=12,warning=F,message=F}
p <- ggplot(data, aes(x=POR_htoct12, fill=as.factor(prov))) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(prov)) + 
  scale_fill_manual(values=c("turquoise2",
                              "turquoise2",
                              "darkorchid3",
                              "darkorchid3",
                              "darkorchid3",
                              "turquoise2",
                              
                              "darkorchid3",
                              "turquoise2",
                              "darkorchid3",
                              "darkorchid3",
                              "green3",
                              "darkorchid3",
                              
                              "navyblue",
                              "turquoise2",
                              "darkorchid3",
                              "orangered3",
                              "navyblue",
                              "darkorchid3",
                              
                              "navyblue",
                              "green3",
                              "navyblue",
                              "gold2",
                              "gold2",
                              "navyblue",
                              
                              "turquoise2",
                              "darkorchid3",
                              "turquoise2",
                              "darkorchid3",
                              "turquoise2",
                              "turquoise2",
                              
                              "navyblue",
                              "orangered3",
                              "darkorchid3",
                              "navyblue")) +
  labs(x="",y="") +
  theme(legend.position = "none")

p
ggsave(p,file="figs/ExploratoryAnalyses/HeightPortugal2012.png",height=10,width=12)
```

```{r POR2012Heightbis, fig.height=10,fig.width=12,warning=F,message=F}
data %>% 
  drop_na(POR_htoct12) %>% 
  droplevels() %>% 
  ggplot(aes(x=POR_htoct12, fill=as.factor(block))) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(block)) + 
  labs(x="",y="") +
  theme(legend.position = "none")
```




# Phenology

## bud burst

```{r BBnas}
data %>% dplyr::select(contains("s3")) %>% summary
```

There is less missing values in 2015.

```{r BBhist, fig.height=10,fig.width=10,warning=F}
plot_grid(
ggplot(data, aes(x= BDX_s32013)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() + 
  labs(x="Bud burst 2013",y="") +
  annotate("text",x=1000,y=900,label=paste0("Var = ",round(var(data$BDX_s32013,na.rm=T),2))),

ggplot(data, aes(x= BDX_s32014)) + 
  geom_histogram(binwidth = 20,fill="seagreen3") +  
  theme_bw() + 
  labs(x="Bud burst 2014",y="") +
  annotate("text",x=1700,y=750,label=paste0("Var = ",round(var(data$BDX_s32014,na.rm=T),2))),

ggplot(data, aes(x= BDX_s32015)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() +
  labs(x="Bud burst 2015",y="") +
  annotate("text",x=1500,y=1500,label=paste0("Var = ",round(var(data$BDX_s32015,na.rm=T),2))),

ggplot(data, aes(x= BDX_s32017)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() +
  labs(x="Bud burst 2017",y="") +
  annotate("text",x=1200,y=900,label=paste0("Var = ",round(var(data$BDX_s32017,na.rm=T),2))))
```


```{r BBhistMean,fig.height=4,fig.width=4}
meanBB <-data %>% 
  dplyr::select(prov,clon,tree,block,BDX_s32013,BDX_s32014,BDX_s32015,BDX_s32017) %>% 
  filter(rowSums(is.na(across(where(is.numeric)))) != ncol(.)-4) %>% 
  dplyr::mutate(mean = rowMeans(select(.,contains("BDX")),na.rm=T))

meanBB %>% 
  ggplot(aes(x= mean)) + 
  geom_histogram(binwidth = 15) +  
  theme_bw() + 
  labs(x="Mean bud burst over the 4 measurement years",y="")
```


```{r BDX2014BB, fig.height=10,fig.width=12,warning=F,message=F}
p <- ggplot(data, aes(x=BDX_s32014, fill=as.factor(prov))) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(prov)) + 
  scale_fill_manual(values=c("turquoise2",
                              "turquoise2",
                              "darkorchid3",
                              "darkorchid3",
                              "darkorchid3",
                              "turquoise2",
                              
                              "darkorchid3",
                              "turquoise2",
                              "darkorchid3",
                              "darkorchid3",
                              "green3",
                              "darkorchid3",
                              
                              "navyblue",
                              "turquoise2",
                              "darkorchid3",
                              "orangered3",
                              "navyblue",
                              "darkorchid3",
                              
                              "navyblue",
                              "green3",
                              "navyblue",
                              "gold2",
                              "gold2",
                              "navyblue",
                              
                              "turquoise2",
                              "darkorchid3",
                              "turquoise2",
                              "darkorchid3",
                              "turquoise2",
                              "turquoise2",
                              
                              "navyblue",
                              "orangered3",
                              "darkorchid3",
                              "navyblue")) +
  labs(x="",y="") +
  theme(legend.position = "none")

p
ggsave(p,file="figs/ExploratoryAnalyses/BudBurstPierroton2014.png",height=10,width=12)
```





## duration of bud burst

```{r DBBnas}
data %>% dplyr::select(contains("dbb")) %>% summary
```

There is less missing values in 2015.

```{r DBBhist, fig.height=10,fig.width=10,warning=F}
plot_grid(
ggplot(data, aes(x= BDX_dbb2013)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() + 
  labs(x="Duration bud burst 2013",y="") +
  annotate("text",x=400,y=500,label=paste0("Var = ",round(var(data$BDX_dbb2013,na.rm=T),2))),

ggplot(data, aes(x= BDX_dbb2014)) + 
  geom_histogram(binwidth = 20,fill="seagreen3") +  
  theme_bw() + 
  labs(x="Duration bud burst 2014",y="") +
  annotate("text",x=750,y=800,label=paste0("Var = ",round(var(data$BDX_dbb2014,na.rm=T),2))),

ggplot(data, aes(x= BDX_dbb2015)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() +
  labs(x="Duration bud burst 2015",y="") +
  annotate("text",x=900,y=1000,label=paste0("Var = ",round(var(data$BDX_dbb2015,na.rm=T),2))),

ggplot(data, aes(x= BDX_dbb2017)) + 
  geom_histogram(binwidth = 20) +  
  theme_bw() +
  labs(x="Duration bud burst 2017",y="") +
  annotate("text",x=800,y=750,label=paste0("Var = ",round(var(data$BDX_dbb2017,na.rm=T),2))))
```


```{r DBBhistMean,fig.height=4,fig.width=4}
meanDBB <- data %>% 
  dplyr::select(prov,clon,tree,block,BDX_dbb2014,BDX_dbb2015,BDX_dbb2017) %>% 
  dplyr::filter(rowSums(is.na(across(where(is.numeric)))) != ncol(.)-4) %>% 
  dplyr::mutate(mean = rowMeans(select(.,contains("BDX")),na.rm=T))

meanDBB %>%   ggplot(aes(x= mean)) + 
  geom_histogram(binwidth = 15) +  
  theme_bw() + 
  labs(x="Mean duration of bud burst over the 3 measurement years",y="")
```


```{r BDX2014DBB, fig.height=10,fig.width=12,warning=F,message=F}
p <- ggplot(data, aes(x=BDX_dbb2014, fill=as.factor(prov))) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(prov)) + 
  scale_fill_manual(values=c("turquoise2",
                              "turquoise2",
                              "darkorchid3",
                              "darkorchid3",
                              "darkorchid3",
                              "turquoise2",
                              
                              "darkorchid3",
                              "turquoise2",
                              "darkorchid3",
                              "darkorchid3",
                              "green3",
                              "darkorchid3",
                              
                              "navyblue",
                              "turquoise2",
                              "darkorchid3",
                              "orangered3",
                              "navyblue",
                              "darkorchid3",
                              
                              "navyblue",
                              "green3",
                              "navyblue",
                              "gold2",
                              "gold2",
                              "navyblue",
                              
                              "turquoise2",
                              "darkorchid3",
                              "turquoise2",
                              "darkorchid3",
                              "turquoise2",
                              "turquoise2",
                              
                              "navyblue",
                              "orangered3",
                              "darkorchid3",
                              "navyblue")) +
  labs(x="",y="") +
  theme(legend.position = "none")

p
ggsave(p,file="figs/ExploratoryAnalyses/DurationBudBurstPierroton2014.png",height=10,width=12)
```




```{r}
table(data$BDX_s12013,data$BDX_s42013) # In 2013, only 32 trees were both measured at stage s1 and s4.
table(data$BDX_s12014,data$BDX_s42014)
table(data$BDX_s12015,data$BDX_s42015)
table(data$BDX_s12017,data$BDX_s42017)
```

**In the following analyses, we are going to select the mean bud burst date over the four years and the mean duration of bud burst over three years, as it will be easier from a statistical point of view (the trait distribution is almost normal), and it buffers the variations among years.**

# Functional traits

## Delta13C

```{r d13C}
data %>% dplyr::select(contains("d13C")) %>% summary
```

```{r d13Chist, fig.height=10,fig.width=10,warning=F}
ggplot(data, aes(x= d13C)) + 
  geom_histogram(binwidth = 0.1,fill="seagreen3") +  
  theme_bw() + 
  labs(x="Delta 13 C",y="") +
  annotate("text",x=-30,y=60,label=paste0("Var = ",round(var(data$d13C,na.rm=T),2)))
```

```{r PORd13C, fig.height=10,fig.width=12,warning=F,message=F}
p <- ggplot(data, aes(x=d13C, fill=as.factor(prov))) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(prov)) + 
  scale_fill_manual(values=c("turquoise2",
                              "turquoise2",
                              "darkorchid3",
                              "darkorchid3",
                              "darkorchid3",
                              "turquoise2",
                              
                              "darkorchid3",
                              "turquoise2",
                              "darkorchid3",
                              "darkorchid3",
                              "green3",
                              "darkorchid3",
                              
                              "navyblue",
                              "turquoise2",
                              "darkorchid3",
                              "orangered3",
                              "navyblue",
                              "darkorchid3",
                              
                              "navyblue",
                              "green3",
                              "navyblue",
                              "gold2",
                              "gold2",
                              "navyblue",
                              
                              "turquoise2",
                              "darkorchid3",
                              "turquoise2",
                              "darkorchid3",
                              "turquoise2",
                              "turquoise2",
                              
                              "navyblue",
                              "orangered3",
                              "darkorchid3",
                              "navyblue")) +
  labs(x="",y="") +
  theme(legend.position = "none")

p
ggsave(p,file="figs/ExploratoryAnalyses/d13C.png",height=10,width=12)
```


## Surface leaf area

```{r SLA}
data %>% dplyr::select(contains("SLA")) %>% summary
```

```{r SLAhist, fig.height=10,fig.width=14,warning=F}
plot_grid(ggplot(data, aes(x= POR_SLA)) + 
  geom_histogram(binwidth = 0.1,fill="seagreen3") +  
  theme_bw() + 
  labs(x="Surface Leaf Area",y="") +
  annotate("text",x=9,y=130,label=paste0("Var = ",round(var(data$POR_SLA,na.rm=T),2))),

ggplot(data, aes(x= log(POR_SLA))) + 
  geom_histogram(binwidth = 0.01,fill="seagreen3") +  
  theme_bw() + 
  labs(x="Surface Leaf Area",y="") +
  annotate("text",x=2.05,y=50,label=paste0("Var = ",round(var(log(data$POR_SLA),na.rm=T),2))),
nrow=1)
```


```{r PORSLA, fig.height=10,fig.width=12,warning=F,message=F}
p <- ggplot(data, aes(x=POR_SLA, fill=as.factor(prov))) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(prov)) + 
  scale_fill_manual(values=c("turquoise2",
                              "turquoise2",
                              "darkorchid3",
                              "darkorchid3",
                              "darkorchid3",
                              "turquoise2",
                              
                              "darkorchid3",
                              "turquoise2",
                              "darkorchid3",
                              "darkorchid3",
                              "green3",
                              "darkorchid3",
                              
                              "navyblue",
                              "turquoise2",
                              "darkorchid3",
                              "orangered3",
                              "navyblue",
                              "darkorchid3",
                              
                              "navyblue",
                              "green3",
                              "navyblue",
                              "gold2",
                              "gold2",
                              "navyblue",
                              
                              "turquoise2",
                              "darkorchid3",
                              "turquoise2",
                              "darkorchid3",
                              "turquoise2",
                              "turquoise2",
                              
                              "navyblue",
                              "orangered3",
                              "darkorchid3",
                              "navyblue")) +
  labs(x="",y="") +
  theme(legend.position = "none")

p
ggsave(p,file="figs/ExploratoryAnalyses/PORSLA.png",height=10,width=12)
```


# All selected traits

```{r DistributionAllSelectedTraits,fig.height=14,fig.width=10,warning=F,message=F}
fontsize=8
ymean = 0.82
yvar = 0.92

p <- plot_grid(
  # Height Fundão (Portugal) 2012
ggplot(data, aes(x= POR_htoct12)) + 
  geom_histogram(binwidth = 20,fill="#B2182B",alpha=0.7) +  
  theme_bw() +
  labs(x="Height (Fundão, 20 months, mm)",y="") +
  annotation_custom(grobTree(textGrob(paste0("Variance : ",
                                             round(var(data$POR_htoct12,na.rm=T),2)), 
                                      x=0.7,  
                                      y=yvar, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))) +
  annotation_custom(grobTree(textGrob(paste0("Mean : ",
                                             round(mean(data$POR_htoct12,na.rm=T),2)), 
                                      x=0.7,  
                                      y=ymean, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))),

  # Height Pierroton 2013
ggplot(data, aes(x= BDX_htnov13)) + 
  geom_histogram(binwidth = 20, fill="#D73027",alpha=0.7) +  
  theme_bw() + 
  labs(x="Height (Pierroton, 25 months, mm)",y="") +
  annotation_custom(grobTree(textGrob(paste0("Variance : ",
                                             round(var(data$BDX_htnov13,na.rm=T),2)), 
                                      x=0.7,  
                                      y=yvar, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))) +
  annotation_custom(grobTree(textGrob(paste0("Mean : ",
                                             round(mean(data$BDX_htnov13,na.rm=T),2)), 
                                      x=0.7,  
                                      y=ymean, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))),

  # Height Pierroton 2018
ggplot(data, aes(x= BDX_htnov18)) + 
  geom_histogram(binwidth = 20, fill="#F46D43",alpha=0.7) +  
  theme_bw() + 
  labs(x="Height (Pierroton, 85 months, mm)",y="") +
  annotation_custom(grobTree(textGrob(paste0("Variance : ",
                                             round(var(data$BDX_htnov18,na.rm=T),2)), 
                                      x=0.7,  
                                      y=yvar, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))) +
  annotation_custom(grobTree(textGrob(paste0("Mean : ",
                                             round(mean(data$BDX_htnov18,na.rm=T),2)), 
                                      x=0.7,  
                                      y=ymean, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))),
  
  # Height Cabada (Asturias) 2012
ggplot(data, aes(x= AST_htnov12)) + 
  geom_histogram(binwidth = 20, fill="#FDAE61",alpha=0.7) +  
  theme_bw() + 
  labs(x="Height (Asturias, 21 months, mm)",y="") +
  annotation_custom(grobTree(textGrob(paste0("Variance : ",
                                             round(var(data$AST_htnov12,na.rm=T),2)), 
                                      x=0.7,  
                                      y=yvar, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))) +
  annotation_custom(grobTree(textGrob(paste0("Mean : ",
                                             round(mean(data$AST_htnov12,na.rm=T),2)), 
                                      x=0.7,  
                                      y=ymean, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))),

  # Mean bud burst date Pierroton
ggplot(meanBB,aes(x= mean)) + 
  geom_histogram(binwidth = 10,fill="#5AAE61",alpha=0.7) +  
  theme_bw() + 
  labs(x="Mean bud burst date (Pierroton, over four years, °C-day)",y="") +
  annotation_custom(grobTree(textGrob(paste0("Variance : ",
                                             round(var(meanBB$mean,na.rm=T),2)), 
                                      x=0.7,  
                                      y=yvar, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))) +
  annotation_custom(grobTree(textGrob(paste0("Mean : ",
                                             round(mean(meanBB$mean,na.rm=T),2)), 
                                      x=0.7,  
                                      y=ymean, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))),

  # Mean duration bud burst Pierroton
ggplot(meanDBB,aes(x= mean)) + 
  geom_histogram(binwidth = 10,fill="#A6DBA0",alpha=0.7) +  
  theme_bw() + 
  labs(x="Mean duration of bud burst (Pierroton, over three years, °C-day)",y="") +
  annotation_custom(grobTree(textGrob(paste0("Variance : ",
                                             round(var(meanDBB$mean,na.rm=T),2)), 
                                      x=0.7,  
                                      y=yvar, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))) +
  annotation_custom(grobTree(textGrob(paste0("Mean : ",
                                             round(mean(meanDBB$mean,na.rm=T),2)), 
                                      x=0.7,  
                                      y=ymean, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))),

  # SLA Fundão 
ggplot(data, aes(x= log(POR_SLA))) + 
  geom_histogram(binwidth = 0.01,fill="#4575B4",alpha=0.7) +  
  theme_bw() + 
  labs(x=TeX("Log(Surface Leaf Area) (Fundão, m$^{2}$/kg)"),y="") +
  annotation_custom(grobTree(textGrob(paste0("Variance : ",
                                             round(var(log(data$POR_SLA),na.rm=T),2)), 
                                      x=0.7,  
                                      y=yvar, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))) +
  annotation_custom(grobTree(textGrob(paste0("Mean : ",
                                             round(mean(log(data$POR_SLA),na.rm=T),2)), 
                                      x=0.7,  
                                      y=ymean, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))),
  # delta 13 C Fundão 
ggplot(data, aes(x= d13C)) + 
  geom_histogram(binwidth = 0.1,fill="#ABD9E9",alpha=0.7) +  
  theme_bw() + 
  labs(x=TeX("$\\delta^{13}C$ (Fundão, ‰)"),y="")+
  annotation_custom(grobTree(textGrob(paste0("Variance : ",
                                             round(var(data$d13C,na.rm=T),2)), 
                                      x=0.7,  
                                      y=yvar, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))) +
  annotation_custom(grobTree(textGrob(paste0("Mean : ",
                                             round(mean(data$d13C,na.rm=T),2)), 
                                      x=0.7,  
                                      y=ymean, 
                                      hjust=0,
                                      gp=gpar(fontsize=fontsize)))),

nrow=4)

p

ggsave(p,file=paste0("figs/ExploratoryAnalyses/TraitsDistribution.png"),width = 10,height=8)
```

```{r TableSuppInfoPhenoData}
# the numbers in the columns "Trees", "Populations" and "Clones" were checked with the model inputs (May 12th)
tibble(Traits=c(rep("Height",4),"Mean bud burst date", "Mean duration of bud burst","Surface Leaf Area","$\\delta^{13}$C"),
       
       "Common gardens"=c("Fundão",rep("Pierroton",2),"Cabada",rep("Pierroton",2),rep("Fundão",2)),
       
       "Dates of measurement" =c("October 2012","November 2013", "November 2018","November 2012", "2013, 2014, 2015, 2017", "2014, 2015 2017", NA,NA),
       
       "Tree age"=c(20,25,85,21,"-","-",NA,NA),
       
       "Survival"=c(
      # Proportion survival Portugal 
      round(table(data$POR_survoct12)[[2]]/(table(data$POR_survoct12)[[1]]+table(data$POR_survoct12)[[2]]),2),
      
       # Proportion survival Pierroton 2013
       round(table(data$BDX_surv13)[[2]]/(table(data$BDX_surv13)[[1]]+table(data$BDX_surv13)[[2]]),2),
       
       # Proportion survival Pierroton 2018
       round(table(data$BDX_surv18)[[2]]/(table(data$BDX_surv18)[[1]]+table(data$BDX_surv18)[[2]]),2),
      
      # Proportion survival Asturias
      round(table(data$AST_survnov12)[[2]]/(table(data$AST_survnov12)[[1]]+table(data$AST_survnov12)[[2]]),2),
 
       "-","-","-","-"),
      
       "Units"=c(rep("mm",4),"°C-day","°C-day","m$^{2}$/kg","‰"),
       
       "Trees"=c(length(data$tree[!is.na(data$POR_htoct12)]),  # height Fundão (Portugal) 2012
                 length(data$tree[!is.na(data$BDX_htnov13)]),  # height Pierroton 2013
                 length(data$tree[!is.na(data$BDX_htnov18)]),  # height Pierroton 2018
                 length(data$tree[!is.na(data$AST_htnov12)]),  # height Cabada (Asturias) 2012
                 length(meanBB$tree[!is.na(meanBB$mean)]),     # mean bud burst date Pierroton
                 length(meanDBB$tree[!is.na(meanDBB$mean)]),   # mean duration bud burst Pierroton
                 length(data$tree[!is.na(data$POR_SLA)]),      # SLA Fundão 
                 length(data$tree[!is.na(data$d13C)])),        # delta 13 C Fundão 
       
        "Populations" = c(length(unique(data$prov[!is.na(data$POR_htoct12)])), # height Portugal 2012
                          length(unique(data$prov[!is.na(data$BDX_htnov13)])), # height Pierroton 2013
                          length(unique(data$prov[!is.na(data$BDX_htnov18)])), # height Pierroton 2018
                          length(unique(data$prov[!is.na(data$AST_htnov12)])), # height Asturias 2012
                          length(unique(meanBB$prov[!is.na(meanBB$mean)])),    # mean bud burst date Pierroton
                          length(unique(meanDBB$prov[!is.na(meanDBB$mean)])),  # mean duration bud burst Pierroton
                          length(unique(data$prov[!is.na(data$POR_SLA)])),     # SLA Fundão 
                          length(unique(data$prov[!is.na(data$d13C)]))),       # delta 13 C Fundão 
                          
        "Clones" = c(length(unique(data$clon[!is.na(data$POR_htoct12)])), # height Portugal 2012
                     length(unique(data$clon[!is.na(data$BDX_htnov13)])), # height Pierroton 2013
                     length(unique(data$clon[!is.na(data$BDX_htnov18)])), # height Pierroton 2018
                     length(unique(data$clon[!is.na(data$AST_htnov12)])), # height Asturias 2012
                     length(unique(meanBB$clon[!is.na(meanBB$mean)])),    # mean bud burst date Pierroton
                     length(unique(meanDBB$clon[!is.na(meanDBB$mean)])),  # mean duration bud burst Pierroton
                     length(unique(data$clon[!is.na(data$POR_SLA)])),     # SLA Fundão 
                     length(unique(data$clon[!is.na(data$d13C)]))),       # delta 13 C Fundão   
       
        "Blocks" = c(length(unique(data$block[!is.na(data$POR_htoct12)])), # height Portugal 2012
                     length(unique(data$block[!is.na(data$BDX_htnov13)])), # height Pierroton 2013
                     length(unique(data$block[!is.na(data$BDX_htnov18)])), # height Pierroton 2018
                     length(unique(data$block[!is.na(data$AST_htnov12)])), # height Asturias 2012
                     length(unique(meanBB$block[!is.na(meanBB$mean)])),    # mean bud burst date Pierroton
                     length(unique(meanDBB$block[!is.na(meanDBB$mean)])),  # mean duration bud burst Pierroton
                     length(unique(data$block[!is.na(data$POR_SLA)])),     # SLA Fundão 
                     length(unique(data$block[!is.na(data$d13C)])))        # delta 13 C Fundão   
          ) %>% 
  
  kable(caption="Table XX of the paper",escape = FALSE) %>%
  
  kable_styling(latex_options =c("striped", "hold_position"))
```



