---
title: "Validation step with independant height data from a progeny test near Asturias"
subtitle: "Associating within-population additive genetic variance with the eight potential drivers"
author: "Juliette Archambeau"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    # code_fold: hide
    toc: true
    toc_depth: 4
    toc_float:
       collapsed: false
    number_sections: true
    highlight: textmate
editor_options: 
  chunk_output_type: console
---

<style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;
  white-space: pre;
}
</style>

<style type="text/css">
div.main-container {
  max-width: 2000px;
  margin-left: auto;
  margin-right: auto;
}
</style>


```{css, echo=FALSE}
pre {
  max-height: 300px;
  overflow-y: auto;
}

pre[class] {
  max-height: 600px;
}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 6,fig.height = 6,cache=F)
options(width = 300)
library(knitr)        # CRAN v1.26
library(reshape2)     # CRAN v1.4.4
library(dplyr)        # CRAN v1.0.0
library(tidyverse)    # CRAN v1.3.0
library(kableExtra)   # CRAN v1.1.0
library(rstan)        # CRAN v2.19.2
library(broom)        # CRAN v0.5.2
library(loo)          # CRAN v2.2.0
library(latex2exp)    # CRAN v0.4.0
library(parallel)
library(tidytidbits)  # CRAN v0.2.3
library(tidybayes)    # CRAN v2.0.1
library(bayesplot)    # CRAN v1.7.1
library(ggplot2)
library(cowplot)      # CRAN v1.0.0
library(readxl)
theme_set(theme_bw(base_size = 20))
color_scheme_set("green")
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```

```{r OptionDocs,echo=F}
# Options for sampling
n_chains <- 4
n_iter <- 2500
n_warm <- 1250
n_thin <- 1
save_warmup = FALSE 

theme_set(theme_bw(base_size = 20))

# option for the MCMC intervals
point.est="median"

conf.level <- 0.95
```

# Load the progeny test data

```{r LoadData, warning=F,message=F}
# Load the progeny test data
data <- read_excel("data/ProgenyTests/F26SNP_d130809_20120515.xls", sheet = 2) %>% # the spreadsheet 2 correspond to measurement in Cavada (Asturias common garden)
  drop_na(Prov_code) # we remove the four rows at the end of the file that have NAs for id, prov id, site...

# Provenance names in the progeny tests:
# prov.progeny <- unique(data$Prov_code) %>% 
#   str_to_upper() %>% 
#   str_sub(1,3) # 30 provenances

# Load CLONAPIN data
clonapin <- readRDS(file="data/ClonapinData/PhenoDataNovember2019_AnnualTraits.rds")

# Provenance names in CLONAPIN
prov.clonapin <- unique(clonapin$prov) %>% setdiff("MAD") # 33 provenances
# prov.progeny[prov.progeny %in% prov.clonapin] # 20 provenances in common
# prov.progeny[!(prov.progeny %in% prov.clonapin)] # 10 provenances that have no match

# But this method to do the name matching is not ok for some provenances such as SanL,
# which is SAL with the CLONAPIN code

# Load the file with the matching of code between CLONAPIN (column "CODE") and the progeny tests (column "CODE_FIELD")
name.clonapin.progeny <- read_csv(file="data/ClonapinData/coordinates_provenances.csv") %>% 
  filter(CODE %in% prov.clonapin) # keep only the 33 provenances of CLONAPIN used in the study

unique(data$Prov_code)[unique(data$Prov_code) %in% name.clonapin.progeny$CODE_FIELD] # 23 provenances in common

# We keep only these 23 provenances
data <- name.clonapin.progeny %>% 
  dplyr::select(CODE,CODE_FIELD) %>% 
  dplyr::rename(Prov_code=CODE_FIELD, Prov_code_clonapin=CODE) %>%  # Prov_code_clonapin is the code names used in CLONAPIN, Prov_code that used in the progeny tests
  right_join(data,by = "Prov_code") %>% 
  drop_na(Prov_code_clonapin)
```

Dataset of `r dim(data)[1]` observations.

# Height distribution - exploratory analyses

We performed these analysis for height measured the 17/12/2007 and height measured in 2010.

```{r WhichTrait,message=F}
# trait <- "HT07"
trait <- "HT10" # Height measurement in 2010
if (trait=="HT10"){
 x.label.histogram= "Height measured in the progeny test of Asturias at XX-month old"
 x.legend = 0.127
} else if(trait=="HT07"){
 x.label.histogram= "Height measured in the progeny test of Asturias at XX-month old"
 x.legend = 0.386
}

# remove NAs for the trait of interest
subdata <- data %>% 
  drop_na(all_of(trait)) %>% 
  mutate(Family.id=paste0(Prov_code_clonapin,"_",Fam)) %>% 
  dplyr::select("Prov_code_clonapin","Prov_code","ID","Fam","Family.id","Block",trait) %>% 
  rename(Trait=trait)
```

```{r HistogramWithZero}
ggplot(subdata, aes(x=Trait)) + 
  geom_histogram(binwidth = 10, fill="seagreen3") +  
  theme_bw() + 
  labs(x=x.label.histogram,y="")
```

We have to remove the zeros because they may represent dead individuals.

```{r RemovingZeros}
# removing zeros
subdata <- subdata %>% filter(!(Trait==0))
```

We have now `r dim(subdata)[[1]]` observations in in the dataset. Let's plot it again:

```{r HistogramWithoutZeros,fig.height=6,fig.width=8}
p <- ggplot(subdata, aes(x=Trait)) + 
  geom_histogram(binwidth = 10, fill="seagreen3",alpha=0.7) +  
  theme_bw() + 
  labs(x=x.label.histogram,y="") +
  theme(axis.title = element_text(size=16),
        axis.text = element_text(size=18)) 
p
ggsave(p,file = paste0("figs/ExploratoryAnalyses/ValidationStep_",trait,".png"),height=6,width=8)
```

```{r HistogramWithoutZerosPopSpecific, fig.height=6, fig.width=8}
p <- ggplot(subdata, aes(x=Trait)) + 
  geom_histogram(alpha=0.7) + 
  theme_bw()  +
  facet_wrap(~as.factor(Prov_code_clonapin)) + 
  labs(x="",y="") +
  theme(axis.text.x = element_text(size=10, angle=25),
        axis.text.y = element_text(size=12),
        strip.text = element_text(size=14)) 
p
ggsave(p,file = paste0("figs/ExploratoryAnalyses/ValidationStep_",trait,"_PopSpecific.png"),height=10,width=13)
```

```{r DesignDataset,message=F}
# Number of individuals per provenance
counts.ind <- subdata %>% 
  dplyr::select(Prov_code_clonapin,Fam,ID) %>% 
  distinct() %>% 
  group_by(Prov_code_clonapin) %>% 
  dplyr::summarise(count.individuals=n())

# Number of family per provenance
counts.fam <- subdata %>% 
  dplyr::select(Prov_code_clonapin,Fam) %>% 
  distinct() %>% 
  group_by(Prov_code_clonapin) %>% 
  dplyr::summarise(count.families=n())

# Mean and variance for height in each provenance (merged with the nb of family per prov)
meta.subdata <- subdata %>% 
  dplyr::select(Prov_code_clonapin,Fam,Trait) %>% 
  group_by(Prov_code_clonapin) %>% 
  summarise(mean=mean(Trait),var=var(Trait)) %>% 
  inner_join(counts.fam,by = "Prov_code_clonapin") %>% 
  inner_join(counts.ind,by = "Prov_code_clonapin")

meta.subdata %>% #print(n=33) %>% 
  kable(digits=2,escape = FALSE) %>%
  kable_styling(font_size=11,
                bootstrap_options = c("striped","hover", "condensed"), full_width = F) %>% 
  column_spec(1, bold = T)
```

```{r TablesLatex,eval=F}
options(knitr.table.format = "latex")
meta.subdata %>% 
  dplyr::rename(Populations=Prov_code_clonapin,
                Mean=mean,
                Variance=var,
                "Number of families"=count.families) %>% 
  kable(escape = FALSE)
```

Correlation between the number of family per provenance and the within-population variance of the trait: `r cor(meta.subdata$var,meta.subdata$count.families) %>%  round(3)`.

Correlation between the number of family per provenance and the within-population mean of the trait: `r cor(meta.subdata$mean,meta.subdata$count.families) %>% round(3)`.

Correlation between the within-population mean and variance of the trait: `r cor(meta.subdata$var,meta.subdata$mean) %>%  round(3)`.

# Model equation and code

We used the same mathematical model as the one used on CLONAPIN data but replacing clones by families. 

We modeled each trait $y_{bpfr}$ such as:

\begin{equation}
\begin{aligned}
y_{bpfr} & \sim  \mathcal{N}(\mu_{bpcf},\sigma^{2}_{r})\\[3pt]
\mu_{bpf} & =  \beta_{0} +  B_{b} + P_{p} + F_{f(p)}\\[3pt]
\end{aligned}
\end{equation}

where $\beta_{0}$ is the global intercept, $B_{b}$ the block intercepts, $P_{p}$ the population intercepts, $F_{f(p)}$ the family intercepts and $\sigma^{2}_{r}$ the residual variance.

The prior of $\beta_{0}$ was weakly informative and centered around the mean of the observed values for the trait under considered, as follows:

$$\beta_{0} \sim \mathcal{N}(\mu_{y},2)$$

The population and block intercepts, $P_{p}$ and $B_{b}$ were considered normally-distributed with variances $\sigma^{2}_{P}$ and $\sigma^{2}_{B}$, such as:

$$\begin{bmatrix} B_{b} \\ P_{p} \end{bmatrix} 
    \sim \mathcal{N}\left(0,
\begin{bmatrix}\sigma^{2}_{B}\\[3pt]
\sigma^{2}_{P}\\
\end{bmatrix}
\right)\\[3pt]$$

The family intercepts $F_{f(p)}$ were considered to follow some population-specific normal distributions, such as:
$$F_{f(p)} \sim \mathcal{N}(0,\sigma^{2}_{F_{p}})$$

where $\sigma^{2}_{F_{p}}$ are the population-specific variances among families.


To partition the total variance, we parameterize our model so that only the total variance, $\sigma_{tot}^{2}$ has a prior, such that:

\begin{equation}
\begin{aligned}
\sigma_{tot}^{2} & = \sigma_{r}^{2} + \sigma_{B}^{2} + \overline{\sigma_{F_{p}}^{2}} + \sigma_{P}^{2}\\[3pt]
\sigma_{r} & = \sigma_{tot} \times \sqrt(\pi_{r})\\[3pt]
\sigma_{B} & = \sigma_{tot} \times \sqrt(\pi_{B})\\[3pt]
\sigma_{P} & = \sigma_{tot} \times \sqrt(\pi_{P})\\[3pt]
\overline{\sigma_{F_{p}}} & = \sigma_{tot} \times \sqrt(\pi_{F})\\[3pt]
\sigma_{tot} & \sim \mathcal{S}^{*}(0,1,3)
\end{aligned}
\end{equation}

where $\overline{\sigma_{F_{p}}}$ and $\overline{\sigma_{F_{p}}^{2}}$ are the mean of the population-specific among-families standard deviations ($\sigma_{F_{p}}$) and variances ($\sigma^{2}_{F_{p}}$), respectively, and $\sum_{l}^{4}\pi_{l}=1$ (using the `simplex` function in `Stan`).


The population-specific among-families standard deviations $\sigma_{F_{p}}$ follow a log-normal distribution with mean $\overline{\sigma_{F_{p}}}$ and variance $\sigma^{2}_{K}$, such as: 

\begin{equation}
\begin{aligned}
\sigma_{F_{p}} & \sim \mathcal{LN}\left(\ln(\overline{\sigma_{F_{p}}})-\frac{\sigma^{2}_{K}}{2} + \beta_{X}X_{p},\sigma^{2}_{K}\right)\\[3pt]
\sigma_{K} & \sim \exp(1)\\[3pt]
\end{aligned}
\end{equation}

with $X_{p}$ the potential driver considered and $\beta_{x}$ its associated coefficient.

```{r ModelCompilation,eval=T}
model = stan_model("scripts/StanModels/HierarchicalModel_VaryingInterClonesSD_OneCovariate.stan")
model
```


# Running the models


```{r StanLists, eval=F}
#### Downloading and merging the dataset with the potential drivers
df <- readRDS(file="data/DF_Drivers.rds") %>% 
  dplyr::select(prov,A,D,EH.20km.PC1,EH.20km.PC2,EH.1km.PC1,EH.1km.PC2,SHM,invEMT) %>% 
  dplyr::mutate(across(-prov,scale)) %>% 
  dplyr::rename(Prov_code_clonapin=prov) %>% 
  right_join(subdata,by="Prov_code_clonapin")

list.trait <- list(df=df)

#### Create the stan lists (one for each driver):
list.stan <- lapply(colnames(df)[2:9], function(x)    {
    list(N=dim(df)[1],
         y=df$Trait,
         X=df[,c(x,"Prov_code_clonapin")] %>% distinct() %>% pull(x) %>% as.numeric(),
         nprov = length(unique(df$Prov_code_clonapin)),
         nclon = length(unique(df$Family.id)),
         nblock = length(unique(df$Block)),
         prov = as.numeric(as.factor(df$Prov_code_clonapin)),
         which_prov = as.numeric(as.factor(pull(unique(df[c("Prov_code_clonapin","Family.id")])[,"Prov_code_clonapin"]))),
         clon = as.numeric(as.factor(df$Family.id)),
         bloc = as.numeric(as.factor(df$Block)))})
  
names(list.stan) <- colnames(df)[2:9]
```

```{r RunModels,eval=F}
list.models <- list()

for(i in names(list.stan)){
  
  list.models[[i]] <- sampling(model, 
                               data = list.stan[[i]], 
                               pars=c("beta0","betaX",
                                      "pi","sigma2_r","sigma2_block","sigma2_prov","sigma2_clon",
                                      "h2_prov",
                                      "sigma_tot","sigma_block","sigma_prov",
                                      "mean_sigma_clon","sigma_clon","sigma_K"#,
                                      #"alpha_clon","alpha_prov",#"alpha_block",
                                      # "y_rep" not included not to have a too heavy file
                                      #"R_squared","log_lik"
                                      ),
                               iter = n_iter, 
                               chains = n_chains, 
                               cores = n_chains,
                               save_warmup = save_warmup,
                               thin=n_thin)
}

saveRDS(list.models,file=paste0("outputs/models/",trait,"_ProgenyTestsAsturias.rds"))
```


# Figures

## $\beta_{X}$

### Trait-specific figures

```{r FigureBetaX, fig.height=7,fig.width=11}
drivers <- c("A","D","EH1[20km]","EH2[20km]","EH1[1.6km]","EH2[1.6km]","SHM","invEMT")# order in the model list, do not change

df <-readRDS(file=paste0("outputs/models/",trait,"_ProgenyTestsAsturias.rds")) %>%  
  mclapply(function(x) broom::tidyMCMC(x,pars=("betaX"),
              droppars = NULL, 
              estimate.method = point.est, 
              ess = F, 
              rhat = F, 
              conf.int = T,
              conf.level = conf.level)) %>% 
  bind_rows() %>% 
  mutate(Xp=drivers) %>% 
  mutate(Hyp=case_when(Xp=="A"~"Admixture",
                       Xp=="D"~"Admixture",
                       Xp=="EH1[20km]"~"Environmental heterogeneity",
                       Xp=="EH2[20km]"~"Environmental heterogeneity",
                       Xp=="EH1[1.6km]"~"Environmental heterogeneity",
                       Xp=="EH2[1.6km]"~"Environmental heterogeneity",
                       Xp=="SHM"~"Climate harshness",
                       Xp=="invEMT"~"Climate harshness"))
  

p <- df %>%   ggplot(aes(x = Xp, y = estimate,ymin = conf.low, ymax = conf.high,colour=drivers)) +
  geom_pointinterval(position = position_dodge(width = .6),point_size=3,alpha=0.6,size=5,show.legend = c(size = TRUE)) +
  facet_grid(.~Hyp,scales="free", space = "free") + 
  ylab(TeX("$\\beta_{X}$ estimates")) + xlab("") +
    scale_color_manual(values=c("#7FBC41", "#4D9221" ,
                              "#DE77AE","#C51B7D" ,
                              "#B2ABD2", "#542788" ,
                              "#E08214" ,"#FDB863" )) +
  theme_bw() +
  
  labs(color = "Potential drivers") +
  theme(axis.text.x = element_text(size=13),
        axis.text.y = element_text(size=16),
        axis.title = element_text(size=16),
      legend.title=element_text(size=13), 
      legend.text=element_text(size=10),
      legend.position = c(x.legend, .13), 
      legend.background = element_rect(colour = "grey"),
      strip.text.x = element_text(size = 14),
      panel.grid.minor.x=element_blank(),
      panel.grid.major.x=element_blank()) +
    guides(color=guide_legend(ncol=2))

p

ggsave(p,file=paste0("figs/PosteriorDistributions/ValidationStep_",trait,"_BetaX.png"),height=7,width=11)
```

### Figure with 5 drivers - Figure 3


```{r FigsTraitSpecific, fig.height=6.5,fig.width=8}
traits <- c("HT07","HT10")
drivers <- c("A","D","EH1[20km]","EH2[20km]","EH1[1.6km]","EH2[1.6km]","SHM","invEMT")   
subdrivers <- c("A","EH1[20km]","EH2[20km]","SHM","invEMT")
param <- "betaX"

ExtractParam <- function(x)  {
  readRDS(file=paste0("outputs/models/",x,"_ProgenyTestsAsturias.rds")) %>% 
  mclapply(function(x) broom::tidyMCMC(x,pars=param,
                droppars = NULL, 
                estimate.method = point.est, 
                ess = F, 
                rhat = F, 
                conf.int = T,
                conf.level = conf.level)) %>% 
  bind_rows() %>% 
  mutate(Xp=drivers,
         Traits=x)
}


df.betaX <- mclapply(traits,ExtractParam)

df.betaX <- df.betaX %>% 
  bind_rows() %>%
  dplyr::filter(Xp %in% subdrivers) %>% 
  mutate(Hyp=case_when(Xp=="A"~"Admixture",
                       Xp=="D"~"Admixture",
                       Xp=="EH1[20km]"~"Environmental heterogeneity",
                       Xp=="EH2[20km]"~"Environmental heterogeneity",
                       Xp=="EH1[1.6km]"~"Environmental heterogeneity",
                       Xp=="EH2[1.6km]"~"Environmental heterogeneity",
                       Xp=="SHM"~"Climate harshness",
                       Xp=="invEMT"~"Climate harshness"))


df.betaX$Xp <- as.factor(df.betaX$Xp)
df.betaX$Xp <- factor(df.betaX$Xp,levels=rev(levels(df.betaX$Xp)))


p <- df.betaX %>%   ggplot(aes(x = Xp, y = estimate,ymin = conf.low, ymax = conf.high,colour=Traits),shape=16) +
  geom_pointinterval(position = position_dodge(width = .6),point_size=2.5,show.legend = c(size = TRUE)) +
  facet_grid(.~Hyp,scales="free", space = "free") + 
  ylab(TeX("$\\beta_{X}$ estimates")) + xlab("") +
  scale_colour_manual(labels = c("Height (2007)","Height (2010)"), 
                      values=c("#FDAE61","#B2182B")) +
  theme_bw() +
  theme(axis.text.x = element_text(size=13),
        axis.text.y = element_text(size=16),
        axis.title = element_text(size=16),
      legend.title=element_text(size=13), 
      legend.text=element_text(size=10),
      legend.position = c(.806, .10), #.414
      legend.background = element_rect(colour = "grey"),
      strip.text.x = element_text(size = 14),
      panel.grid.minor.x=element_blank(),
      panel.grid.major.x=element_blank()) +
    guides(color=guide_legend(ncol=2))

p
ggsave(p, file="figs/PosteriorDistributions/ValidationStep_5Drivers_BetaX_PaperFig.png",height=6.5,width=8)
```


### Figure with all drivers - Figure Supp Info

```{r FigSuppInfo,fig.height=6.5,fig.width=10.5}
traits <- c("HT07","HT10")
drivers <- c("A","D","EH1[20km]","EH2[20km]","EH1[1.6km]","EH2[1.6km]","SHM","invEMT")   
param <- "betaX"

ExtractParam <- function(x)  {
  readRDS(file=paste0("outputs/models/",x,"_ProgenyTestsAsturias.rds")) %>% 
  mclapply(function(x) broom::tidyMCMC(x,pars=param,
                droppars = NULL, 
                estimate.method = point.est, 
                ess = F, 
                rhat = F, 
                conf.int = T,
                conf.level = conf.level)) %>% 
  bind_rows() %>% 
  mutate(Xp=drivers,
         Traits=x)
}


df.betaX <- mclapply(traits,ExtractParam)

df.betaX <- df.betaX %>% 
  bind_rows() %>%
  mutate(Hyp=case_when(Xp=="A"~"Admixture",
                       Xp=="D"~"Admixture",
                       Xp=="EH1[20km]"~"Environmental heterogeneity",
                       Xp=="EH2[20km]"~"Environmental heterogeneity",
                       Xp=="EH1[1.6km]"~"Environmental heterogeneity",
                       Xp=="EH2[1.6km]"~"Environmental heterogeneity",
                       Xp=="SHM"~"Climate harshness",
                       Xp=="invEMT"~"Climate harshness"))


df.betaX$Xp <- as.factor(df.betaX$Xp)
df.betaX$Xp <- factor(df.betaX$Xp,levels=rev(levels(df.betaX$Xp)))


p <- df.betaX %>%   ggplot(aes(x = Xp, y = estimate,ymin = conf.low, ymax = conf.high,colour=Traits),shape=16) +
  geom_pointinterval(position = position_dodge(width = .6),point_size=2.5,show.legend = c(size = TRUE)) +
  facet_grid(.~Hyp,scales="free", space = "free") + 
  ylab(TeX("$\\beta_{X}$ estimates")) + xlab("") +
  scale_colour_manual(labels = c("Height (2007)","Height (2010)"), 
                      values=c("#FDAE61","#B2182B")) +
  theme_bw() +
  theme(axis.text.x = element_text(size=13),
        axis.text.y = element_text(size=16),
        axis.title = element_text(size=16),
      legend.title=element_text(size=13), 
      legend.text=element_text(size=10),
      legend.position = c(.47, .09), #.414
      legend.background = element_rect(colour = "grey"),
      strip.text.x = element_text(size = 14),
      panel.grid.minor.x=element_blank(),
      panel.grid.major.x=element_blank()) +
    guides(color=guide_legend(ncol=2))

p
ggsave(p, file="figs/PosteriorDistributions/ValidationStep_AllDrivers_BetaX_PaperFig.png",height=6.5,width=10.5)
```


## $\sigma^{2}_{C_{p}}$

```{r SigmaClon,eval=F}
traits <- c("HT07","HT10")
drivers <- c("A","D","EH1[20km]","EH2[20km]","EH1[1.6km]","EH2[1.6km]","SHM","invEMT")   

provs <- unique(data$Prov_code_clonapin) %>% str_sort()

mclapply(traits,function(x){

legend.position <- c(.15, .86)
  
p <- readRDS(file=paste0("outputs/models/",x,"_ProgenyTestsAsturias.rds")) %>% 
  mclapply(function(x) {
    broom::tidyMCMC(x,pars=("sigma2_clon"),
                droppars = NULL, 
                estimate.method = point.est, 
                ess = F, 
                rhat = F, 
                conf.int = T,
                conf.level = conf.level)}) %>%  
  bind_rows(.id="Drivers") %>% 
  mutate(Traits=x,
         prov=rep(provs,8)) %>% 
  ggplot(aes(x = prov, y = estimate,ymin = conf.low, ymax = conf.high,color=Drivers)) +
  geom_pointinterval(position = position_dodge(width = .8),point_size=2,alpha=0.6,size=4) +
  scale_color_manual(values=c("#7FBC41", "#4D9221" ,
                              "#DE77AE","#C51B7D" ,
                              "#B2ABD2", "#542788" ,
                              "#E08214" ,"#FDB863" ),
                     labels=c("A","D","EH1[1.6km]","EH2[1.6km]","EH1[20km]","EH2[20km]","invEMT","SHM")) +
  xlab("Populations") +
  ylab(TeX("$\\sigma^{2}_{C_{p}}$ estimates")) +
  labs(color = "Potential drivers") +
  theme(legend.position = legend.position,
        legend.background = element_rect(colour = "grey"),
        panel.grid.minor.x=element_blank(),
        panel.grid.major.x=element_blank())  +
    guides(color=guide_legend(ncol=4))

ggsave(p,file=paste0("figs/PosteriorDistributions/ValidationStep_",x,"_SigmaClon.png"),height=6,width=22)
  
})
```

## Heritabilities

We calculated population-specific heritabilities, such as:

$$ h^2_{p} = \frac{\sigma^{2}_{C_{p}}}{\sigma^{2}_{C_{p}} + \sigma^{2}_r} $$

```{r H2Figures,eval=F}
traits <- c("HT07","HT10")
drivers <- c("A","D","EH1[20km]","EH2[20km]","EH1[1.6km]","EH2[1.6km]","SHM","invEMT")   

provs <- unique(data$Prov_code_clonapin) %>% str_sort()

mclapply(traits,function(x){
  
legend.position <- c(.15, .86)
  
p <- readRDS(file=paste0("outputs/models/",x,"_ProgenyTestsAsturias.rds")) %>% 
  mclapply(function(x) {
    broom::tidyMCMC(x,pars=("h2_prov"),
                droppars = NULL, 
                estimate.method = point.est, 
                ess = F, 
                rhat = F, 
                conf.int = T,
                conf.level = conf.level)}) %>%  
  bind_rows(.id="Drivers") %>% 
  mutate(Traits=x,
         prov=rep(provs,8)) %>% 
  ggplot(aes(x = prov, y = estimate,ymin = conf.low, ymax = conf.high,color=Drivers)) +
  geom_pointinterval(position = position_dodge(width = .8),point_size=2,alpha=0.6,size=4) +
  scale_color_manual(values=c("#7FBC41", "#4D9221" ,
                              "#DE77AE","#C51B7D" ,
                              "#B2ABD2", "#542788" ,
                              "#E08214" ,"#FDB863" ),
                     labels=c("A","D","EH1[1.6km]","EH2[1.6km]","EH1[20km]","EH2[20km]","invEMT","SHM")) +
  xlab("Populations") +
  ylab(TeX("$\\H^{2}_{p}$ estimates")) +
  labs(color = "Potential drivers") +
  theme(legend.position = legend.position,
        legend.background = element_rect(colour = "grey"),
        panel.grid.minor.x=element_blank(),
        panel.grid.major.x=element_blank())  +
    guides(color=guide_legend(ncol=4))

ggsave(p,file=paste0("figs/PosteriorDistributions/ValidationStep_",x,"_h2prov.png"),height=6,width=22)
  
})

```

## Variance partitioning


```{r VartPartFigs,eval=F}
traits <- c("HT07","HT10")
drivers <- c("A","D","EH1[20km]","EH2[20km]","EH1[1.6km]","EH2[1.6km]","SHM","invEMT")   

mclapply(traits,function(x){
  p <- readRDS(file=paste0("outputs/models/",x,"_ProgenyTestsAsturias.rds")) %>% 
  mclapply(function(x) {
    broom::tidyMCMC(x,pars=("pi"),
                droppars = NULL, estimate.method = point.est, ess = F, rhat = F, conf.int = T,conf.level = 0.95)}) %>%  
  bind_rows(.id="Drivers") %>% 
  mutate(Traits=x,
         prop.var=rep(c("sigma_r","sigma_block","sigma_prov","mean_sigma_clon"),8)) %>% 
  
  ggplot(aes(x = prop.var, y = estimate,ymin = conf.low, ymax = conf.high,color=Drivers)) +
  geom_pointinterval(position = position_dodge(width = .8),point_size=3,alpha=0.6,size=5) +
  scale_color_manual(values=c("#7FBC41", "#4D9221" ,
                              "#DE77AE","#C51B7D" ,
                              "#B2ABD2", "#542788" , #"#2D004B","#8073AC" ,
                              "#E08214" ,"#FDB863" ),
                     labels=c("A","D","EH1[1.6km]","EH2[1.6km]","EH1[20km]","EH2[20km]","invEMT","SHM")) +
  xlab("") +
  ylab("Proportion of variance explained") +
  labs(color = "Potential drivers") +
  scale_x_discrete(labels=c("Clones",
                            "Blocks",
                            "Populations",
                            "Residuals"
                            )) +
  theme(legend.position = c(.135, .81),
        legend.background = element_rect(colour = "grey"),
        axis.text = element_text(size=25),
        panel.grid.minor.x=element_blank(),
        panel.grid.major.x=element_blank())  +
    guides(color=guide_legend(ncol=2))

ggsave(p,file=paste0("figs/PosteriorDistributions/ValidationStep_",x,"_VarPart.png"),height=6,width=18)
  
})

```

